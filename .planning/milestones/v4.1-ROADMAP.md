# Milestone v4.1: Flash All Safety & Cleanup

**Status:** ✅ SHIPPED 2026-02-01
**Phases:** 28-30
**Total Plans:** 3

## Overview

Close safety gaps in Flash All targeting, add hardware MCU cross-check, align safety prompts for Moonraker failures, and remove dead settings — all blocking issues from beta review.

## Phases

### Phase 28: Flash All Preflight

**Goal**: Flash All fails fast on environment problems and prevents duplicate device targeting
**Depends on**: Nothing (first phase in milestone)
**Plans**: 1 plan

Plans:
- [x] 28-01: Preflight checks, Moonraker prompt, and duplicate USB path guard

**Details:**
- Added `_preflight_flash()` call before batch loop — validates Klipper dir, Makefile, make command, Katapult flashtool
- Added Moonraker unreachable confirmation prompt matching single-device flow
- Added `used_paths: set[str]` with `os.path.realpath()` to prevent duplicate USB device targeting
- Removed duplicate Stage 4 print status check

### Phase 29: Flash Workflow Hardening

**Goal**: Flash workflows detect MCU mismatches and surface build failures clearly
**Depends on**: Phase 28
**Plans**: 1 plan

Plans:
- [x] 29-01: MCU cross-check before flashing and build error output capture

**Details:**
- Added `error_output: Optional[str]` to `BuildResult` and `BatchDeviceResult`
- `run_build()` captures combined stdout+stderr on failure when `quiet=True` (capped at 200 lines)
- MCU cross-check via `extract_mcu_from_serial()` — interactive warns+prompts, batch skips+reports
- Flash All summary shows last 20 lines of build output inline on failure
- Best-effort: check skipped silently when MCU extraction returns None

### Phase 30: Dead Setting Removal

**Goal**: config_cache_dir setting no longer exists anywhere in the codebase
**Depends on**: Nothing (independent cleanup)
**Plans**: 1 plan

Plans:
- [x] 30-01: Remove config_cache_dir from models, registry, and settings screen

**Details:**
- Removed `config_cache_dir: str` field from GlobalConfig dataclass (models.py)
- Removed from registry load/save serialization (registry.py)
- Removed from settings screen SETTINGS list (screen.py)
- `get_config_dir()` continues using XDG convention independently

---

## Milestone Summary

**Key Decisions:**
- MCU cross-check is best-effort — skipped silently when extraction returns None (not all USB filenames contain MCU info)
- Preflight runs once before batch loop, not per-device
- Build output capture only when quiet=True (batch mode)

**Issues Resolved:**
- Flash All could proceed with missing environment (Klipper dir, make, Katapult)
- Flash All had no Moonraker safety prompt (single-device did)
- Same USB device could be targeted by multiple registry entries
- MCU type mismatches between USB device and registry went undetected
- Build failures in Flash All showed no diagnostic output
- Dead config_cache_dir setting confused users

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None

---

_For current project status, see .planning/ROADMAP.md_
