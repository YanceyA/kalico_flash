# Requirements Archive: v1.0 klipper-flash MVP

**Archived:** 2026-01-25
**Status:** SHIPPED

This is the archived requirements specification for v1.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: klipper-flash

**Defined:** 2026-01-25
**Core Value:** One command to build and flash any registered board — no remembering serial paths, flash commands, or config locations.

## v1 Requirements

### Device Discovery

- [x] **DISC-01**: Tool scans /dev/serial/by-id/ and matches devices against registered klipper serial patterns
- [x] **DISC-02**: Discovered devices display with friendly names (registered) or "Unknown" (unregistered)
- [x] **DISC-03**: Unregistered devices are flagged with option to register via add-device wizard
- [x] **DISC-04**: Connection status shown for all registered devices (connected/disconnected)
- [x] **DISC-05**: Device path re-verified immediately before flash (after menuconfig + build delay)

### Config Management

- [x] **CONF-01**: Per-device .config cached in configs/ directory (copied to/from klipper_dir/.config)
- [x] **CONF-02**: All file writes use atomic pattern (write to .tmp, rename to final) to prevent SD card corruption
- [x] **CONF-03**: MCU type parsed from .config and validated against device registry before flash — refuse on mismatch

### Build

- [x] **BILD-01**: make menuconfig (ncurses TUI) runs before each build with inherited stdio
- [x] **BILD-02**: make clean followed by make -j$(nproc) executes full firmware build
- [x] **BILD-03**: Build output streams to terminal in real-time (no buffering)
- [x] **BILD-04**: klipper.bin size reported after successful build as sanity check

### Flash

- [x] **FLSH-01**: Katapult (flashtool.py) attempted first as primary flash method
- [x] **FLSH-02**: If katapult fails, automatically falls back to make flash
- [x] **FLSH-03**: Flash uses /dev/serial/by-id/ symlink paths (stable across reboots)

### Service Management

- [x] **SRVC-01**: Klipper service stopped before flash via sudo systemctl stop klipper
- [x] **SRVC-02**: Klipper service always restarted after flash — success, failure, exception, or Ctrl+C — via context manager with finally block
- [x] **SRVC-03**: Passwordless sudo verified before any service operation — clear error if not configured

### Device Registry

- [x] **RGST-01**: Device registry stored in devices.json with friendly name, MCU, serial pattern, flash method, paths
- [x] **RGST-02**: --add-device wizard: select USB device, set name, MCU, serial pattern, klipper/katapult paths, run initial menuconfig, cache config
- [x] **RGST-03**: --remove-device NAME deletes device from registry and optionally removes cached config
- [x] **RGST-04**: --list-devices shows all registered devices with connection status
- [x] **RGST-05**: --device NAME selects device directly, skipping interactive selection

### CLI & UX

- [x] **CLUX-01**: Phase-labeled console output: [Discovery], [Config], [Build], [Flash] prefixes
- [x] **CLUX-02**: Subprocess timeouts on all calls except menuconfig (build: 300s, flash: 60s, service: 30s)
- [x] **CLUX-03**: Clear error messages on failure: what failed, command run, likely cause, recovery steps
- [x] **CLUX-04**: Success/failure summary at end of run

### Architecture

- [x] **ARCH-01**: Core logic in importable Python modules with callable interfaces — no sys.exit() or hardcoded I/O in library code
- [x] **ARCH-02**: CLI (flash.py) is a thin wrapper over core modules — all logic accessible programmatically
- [x] **ARCH-03**: Output via pluggable callback/interface, not hardcoded print — enables future Moonraker integration
- [x] **ARCH-04**: Hub-and-spoke module design: orchestrator coordinates, modules don't call each other directly
- [x] **ARCH-05**: Dataclasses for cross-module data contracts (DeviceEntry, DiscoveredDevice)
- [x] **ARCH-06**: No external dependencies — Python 3.9+ stdlib only

## v2 Requirements (Deferred)

### Config Intelligence

- **CONF-V2-01**: SHA256 change detection to skip rebuild when config unchanged
- **CONF-V2-02**: --skip-menuconfig flag to skip TUI when cached config exists
- **CONF-V2-03**: Klipper git commit hash tracked alongside cached config for version awareness

### Flash Recovery

- **FLSH-V2-01**: Dual serial patterns per device (klipper + katapult) for bootloader mode detection
- **FLSH-V2-02**: Post-flash verification (check device reappears with klipper serial pattern)
- **FLSH-V2-03**: Moonraker print status check before stopping klipper (refuse if printing)

### Quality of Life

- **QUAL-V2-01**: --no-clean flag for incremental builds
- **QUAL-V2-02**: Config normalization to reduce false-positive change detection
- **QUAL-V2-03**: SIGHUP handling for SSH disconnect resilience

## Out of Scope

| Feature | Reason |
|---------|--------|
| RPi MCU flashing | Different workflow (linux process, not USB serial) |
| CAN bus device discovery | Different discovery mechanism, separate domain |
| Moonraker API component | v1 is CLI only; architecture supports future integration |
| Multi-device batch flash | Different error handling model, defer to v2+ |
| Firmware version tracking/rollback | Requires git integration with Klipper tree |
| Automatic klipper git pull | Dangerous — breaks user control, especially on Kalico fork |
| Dry-run mode | Unnecessary complexity for SSH workflow |
| GUI/TUI wrapper | menuconfig is the only TUI; no custom UI needed |
| Plugin system | Only 2 flash methods — hard-code them |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| DISC-01 | Phase 1 | Complete |
| DISC-02 | Phase 1 | Complete |
| DISC-03 | Phase 1 | Complete |
| DISC-04 | Phase 1 | Complete |
| DISC-05 | Phase 3 | Complete |
| CONF-01 | Phase 2 | Complete |
| CONF-02 | Phase 2 | Complete |
| CONF-03 | Phase 2 | Complete |
| BILD-01 | Phase 2 | Complete |
| BILD-02 | Phase 2 | Complete |
| BILD-03 | Phase 2 | Complete |
| BILD-04 | Phase 2 | Complete |
| FLSH-01 | Phase 3 | Complete |
| FLSH-02 | Phase 3 | Complete |
| FLSH-03 | Phase 3 | Complete |
| SRVC-01 | Phase 3 | Complete |
| SRVC-02 | Phase 3 | Complete |
| SRVC-03 | Phase 3 | Complete |
| RGST-01 | Phase 1 | Complete |
| RGST-02 | Phase 1 | Complete |
| RGST-03 | Phase 1 | Complete |
| RGST-04 | Phase 1 | Complete |
| RGST-05 | Phase 1 | Complete |
| CLUX-01 | Phase 3 | Complete |
| CLUX-02 | Phase 3 | Complete |
| CLUX-03 | Phase 3 | Complete |
| CLUX-04 | Phase 3 | Complete |
| ARCH-01 | Phase 1 | Complete |
| ARCH-02 | Phase 1 | Complete |
| ARCH-03 | Phase 1 | Complete |
| ARCH-04 | Phase 1 | Complete |
| ARCH-05 | Phase 1 | Complete |
| ARCH-06 | Phase 1 | Complete |

**Coverage:**
- v1 requirements: 33 total
- Shipped: 33/33 (100%)
- Adjusted: 0
- Dropped: 0

---

## Milestone Summary

**Shipped:** 33 of 33 v1 requirements
**Adjusted:** None — all requirements implemented as originally specified
**Dropped:** None

---
*Archived: 2026-01-25 as part of v1.0 milestone completion*
