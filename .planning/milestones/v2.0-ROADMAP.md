# Milestone v2.0: Public Release

**Status:** SHIPPED 2026-01-27
**Phases:** 4-7
**Total Plans:** 12

## Overview

v2.0 transforms kalico-flash from a working tool into a polished public release. The milestone delivers safety checks (never flash during a print), verification (know the flash succeeded), and user experience improvements (interactive menu, better errors). All features gracefully degrade when optional services are unavailable.

Four phases move from foundation (skip-menuconfig, device exclusion, error messages) through Moonraker integration (print safety, version detection) to user experience (TUI menu, post-flash verification) and release polish (installation script, documentation).

## Phases

### Phase 4: Foundation (v2.0)

**Goal:** Establish core infrastructure for power users and error handling

**Dependencies:** v1.0 complete (phases 1-3)

**Requirements:** SKIP-01 to SKIP-05, EXCL-01 to EXCL-05, ERR-01 to ERR-06 (16 total)

**Plans:**
- [x] 04-01: Error message framework with context and recovery guidance
- [x] 04-02: Device exclusion schema with backward-compatible registry
- [x] 04-03: Skip-menuconfig flag and device exclusion CLI commands
- [x] 04-04: Integrate error framework into flash.py error paths
- [x] 04-05: Update supporting modules with format_error()

**Success Criteria:**
1. User can run `kflash --device octopus-pro -s` and skip menuconfig when cached config exists
2. User sees helpful error with recovery steps when running `--skip-menuconfig` without cached config
3. User can register Beacon probe as non-flashable and it appears in list but not flash selection
4. User sees numbered recovery steps with copy-paste diagnostic commands on any error
5. All error messages fit on 80-column terminal and include context (device name, MCU type, path)

---

### Phase 5: Moonraker Integration

**Goal:** Users have safety checks and version awareness before flashing

**Dependencies:** Phase 4 (error messages for Moonraker failure scenarios)

**Requirements:** SAFE-01 to SAFE-06, VER-01 to VER-07 (13 total)

**Plans:**
- [x] 05-01: Create moonraker.py module with API client and version functions
- [x] 05-02: Integrate Moonraker safety checks into flash workflow

**Success Criteria:**
1. User attempting to flash during active print sees "Print in progress: filename (45%)" and flash is blocked
2. User can flash when Moonraker reports idle, complete, cancelled, or error state
3. User sees warning and confirmation prompt when Moonraker is unreachable (not blocked)
4. User sees host Klipper version vs MCU firmware version before flash, with indication if update needed
5. User with multiple MCUs sees version info for the specific MCU being flashed

---

### Phase 6: User Experience

**Goal:** Interactive users have menu-driven workflow and flash verification

**Dependencies:** Phase 5 (Moonraker for print check), Phase 4 (error messages for verification failures)

**Requirements:** TUI-01 to TUI-08, VERIFY-01 to VERIFY-06 (14 total)

**Plans:**
- [x] 06-01: TUI module core: menu loop, unicode detection, entry point routing
- [x] 06-02: Menu actions and settings submenu with retry logic
- [x] 06-03: Post-flash verification with polling and progress feedback

**Success Criteria:**
1. User running `kflash` with no args sees numbered menu
2. User can navigate menu, complete actions, and return to menu until choosing Exit
3. User receives confirmation message with device path after successful flash, or recovery steps if device does not reappear within 30 seconds
4. User sees box-drawn menu in UTF-8 terminals, clean ASCII menu over legacy SSH connections
5. User in non-TTY environment sees helpful error instead of broken menu

---

### Phase 7: Release Polish

**Goal:** New users can install and learn the tool from documentation

**Dependencies:** Phase 6 (all features complete for documentation)

**Requirements:** INST-01 to INST-06, DOC-01 to DOC-06 (12 total)

**Plans:**
- [x] 07-01: Install script with symlink, PATH handling, and argparse fix
- [x] 07-02: README documentation for public release

**Success Criteria:**
1. User can run `./install.sh` and have working `kflash` command without sudo
2. User sees clear feedback on install success, including warning if ~/.local/bin not in PATH
3. User following README quick start can go from git clone to first flash
4. User encountering common errors can find troubleshooting via inline error messages
5. User can configure Moonraker Update Manager to auto-update kalico-flash

---

## Milestone Summary

**Key Decisions:**

Phase 4:
- format_error() for all error output (consistent 80-column wrapped output)
- ERROR_TEMPLATES dict for centralized error messages
- flashable field defaults to True (backward compatibility)
- Skip-menuconfig warns if no cache, then launches menuconfig anyway

Phase 5:
- Hardcoded localhost:7125 URL (no custom URL support)
- Graceful degradation pattern (return None on failure, never raise)
- Version check is informational only, never blocks flash
- No --force flag for print blocking (safety first)

Phase 6:
- Action handlers call existing flash.py commands (hub-and-spoke)
- Late imports in action handlers (fast startup)
- Post-flash verification inside klipper_service_stopped() context
- Progress dots every 2 seconds during verification polling

Phase 7:
- Symlink over wrapper script (simpler, uses Python shebang)
- Warn-only prerequisite checks (don't fail install)
- No troubleshooting section (inline error messages sufficient)

**Issues Resolved:**

- format_error() destroying numbered lists (fixed: wrap each line individually)
- All error paths now use error_with_recovery() consistently
- Post-flash verification timeout extended to 30s for RP2040 compatibility

**Issues Deferred:**

None - all v2.0 requirements satisfied.

**Technical Debt:**

From v1.0 (carried forward):
- cmd_build() orphaned (no --build-only argparse flag)
- Builder class orphaned (convenience wrapper never used)
- DeviceNotFoundError, BuildError, FlashError defined but never raised

---

_For current project status, see .planning/ROADMAP.md_

---
*Archived: 2026-01-27 as part of v2.0 milestone completion*
