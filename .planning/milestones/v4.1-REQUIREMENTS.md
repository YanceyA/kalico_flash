# Requirements Archive: v4.1 Flash All Safety & Cleanup

**Archived:** 2026-02-01
**Status:** ✅ SHIPPED

This is the archived requirements specification for v4.1.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

## v4.1 Requirements

### Flash All Safety

- [x] **SAFE-01**: Flash All calls `_preflight_flash()` (or batch-safe variant) once before entering the batch loop — fails early if Klipper dir, Makefile, make command, or Katapult flashtool are missing
- [x] **SAFE-02**: Flash All prompts for confirmation when Moonraker is unreachable (`get_print_status()` returns None), matching the single-device flow behavior
- [x] **SAFE-03**: Hardware MCU cross-check before flashing — derive MCU type from connected USB device via `extract_mcu_from_serial()` and compare to registry `entry.mcu`. Single-device interactive: warn and require confirmation on mismatch. Flash All: skip device and report mismatch. Best-effort (skip check if extraction returns None).
- [x] **SAFE-04**: Flash All tracks used USB paths (`used_paths: set[str]`) to prevent the same physical USB device being targeted by two different registry entries

### Flash All Debuggability

- [x] **DBUG-01**: Flash All captures build stdout/stderr and on failure shows the last 20 lines inline in the batch summary. Full output stored in `BuildResult.error_output`.

### Settings Cleanup

- [x] **CONF-01**: Remove `config_cache_dir` setting from GlobalConfig (models.py), registry serialization (registry.py), settings UI (screen.py), and validation (validation.py). `get_config_dir()` continues using XDG convention.

## Out of Scope

| Feature | Reason |
|---------|--------|
| Unit tests | Deferred — separate milestone |
| Non-interactive/batch mode (`--yes`, `--force`) | CLI deprecated, TUI is inherently interactive |
| `build_flash_candidates()` refactor (finding 4) | Post-beta cleanup, not a bug fix |
| Config cache dir implementation | Removing the dead setting instead |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| SAFE-01 | Phase 28 | Complete |
| SAFE-02 | Phase 28 | Complete |
| SAFE-03 | Phase 29 | Complete |
| SAFE-04 | Phase 28 | Complete |
| DBUG-01 | Phase 29 | Complete |
| CONF-01 | Phase 30 | Complete |

---

## Milestone Summary

**Shipped:** 6 of 6 requirements
**Adjusted:** None
**Dropped:** None

---
*Archived: 2026-02-01 as part of v4.1 milestone completion*
