# Milestone v3.4: Check Katapult

**Status:** ✅ SHIPPED 2026-01-31
**Phases:** 21-23
**Total Plans:** 3

## Overview

Add Katapult bootloader detection to the device config screen — probe a device to determine if Katapult is installed. After live hardware testing, the feature was parked (code retained, UI removed) due to recovery limitations discovered during testing.

## Phases

### Phase 21: Pi Hardware Research
**Goal**: Resolve all open hardware questions via SSH testing on live Pi with connected boards
**Depends on**: Phase 20
**Plans**: 1 plan

Plans:
- [x] 21-01: Validate research completeness and write summary

**Details:**
- sysfs path resolution from /dev/serial/by-id/ to USB authorized file documented with working code
- MCU serial substring extraction verified — same substring in both Klipper_ and katapult_ device names
- Timing measurements: flashtool.py -r ~1367ms, sysfs reset ~1063ms, re-enum ~500ms
- flashtool.py -r behavior documented for 3 scenarios (Klipper stopped, service active, already Katapult)
- Beacon probe confirmed excluded via usb-Beacon_* prefix

### Phase 22: Core Detection Engine
**Goal**: Reusable check_katapult() function with helpers for bootloader detection and USB recovery
**Depends on**: Phase 21
**Plans**: 1 plan

Plans:
- [x] 22-01: KatapultCheckResult dataclass, helper functions, check_katapult() core logic

**Details:**
- KatapultCheckResult dataclass with tri-state has_katapult (True/False/None) and error context
- check_katapult() triggers bootloader entry via flashtool.py -r, polls for katapult_ device
- Three helper functions: _resolve_usb_sysfs_path, _usb_sysfs_reset, _poll_for_serial_device
- Timing constants derived from Phase 21 research (250ms poll, 5s timeout)

### Phase 23: TUI Integration
**Goal**: Users can check Katapult from the device config screen via key handler with safety gates
**Depends on**: Phase 22
**Plans**: 1 plan

Plans:
- [x] 23-01: Wire key handler in device config screen with warning, confirmation, service lifecycle, result display

**Details:**
- Warning message explains bootloader mode and recovery options
- Confirmation prompt defaults to No — user must actively opt in
- Klipper service stopped before check, guaranteed restart after (via existing context manager)
- Tri-state result display: Katapult detected / not detected / inconclusive with explanation

---

## Milestone Summary

**Feature Status: PARKED**

After implementation and live hardware testing on STM32F411, STM32H723, and RP2040 boards, the Katapult check feature was parked. The code remains in flasher.py (check_katapult(), helpers, KatapultCheckResult) but the UI trigger was removed from the device config screen.

**Reasons for parking:**
- Katapult devices cannot be auto-recovered to Klipper mode (flashtool.py -r re-enters bootloader, sysfs reset re-enters Katapult)
- Devices without Katapult enter native DFU mode and require manual USB unplug/replug
- Only recovery method is reflashing firmware, which requires correct menuconfig
- Insufficient board variety for thorough testing

**What was retained:**
- All detection engine code in flasher.py (check_katapult, helpers, dataclass, constants)
- All research documentation in phase 21 summaries
- Feature can be re-enabled by adding it back to DEVICE_SETTINGS and wiring a key handler

**Key Decisions:**
- Parked feature after live testing revealed recovery limitations
- Code retained for future revisit with more boards and better recovery strategy

**Issues Resolved:**
- None (feature parked before shipping to users)

**Issues Deferred:**
- Auto-recovery from Katapult mode (no known software method)
- DFU mode recovery (requires manual intervention)
- Testing on wider variety of MCU boards

**Technical Debt Incurred:**
- Dead code in flasher.py (check_katapult and helpers) — intentionally retained for future use

---

_For current project status, see .planning/ROADMAP.md_
