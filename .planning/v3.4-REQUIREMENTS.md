# Requirements: v3.4 Check Katapult

**Defined:** 2026-01-31
**Core Value:** One command to build and flash any registered board — no remembering serial paths, flash commands, or config locations.

## v3.4 Requirements

### Research & Testing

- [ ] **RES-01**: Verify sysfs path resolution from /dev/serial/by-id/ symlink to USB device authorized file on Pi hardware
- [ ] **RES-02**: Verify MCU serial substring persists across Klipper→Katapult device name transitions
- [ ] **RES-03**: Measure timing for bootloader entry, sysfs USB reset, and device re-enumeration
- [ ] **RES-04**: Test flashtool.py -r behavior on device already in Katapult bootloader mode
- [ ] **RES-05**: Verify Beacon probe exclusion (flashable=False devices skipped)

### Core Detection

- [ ] **DET-01**: Reusable check_katapult() function in flasher.py that probes a single USB device for Katapult bootloader
- [ ] **DET-02**: Detection triggers bootloader entry via flashtool.py -r, polls /dev/serial/by-id/ for katapult_ prefix
- [ ] **DET-03**: Auto-recovery via sysfs USB reset when device enters DFU/BOOTSEL (no Katapult installed)
- [ ] **DET-04**: Recovery polling confirms device returns to Klipper_ serial after check completes
- [ ] **DET-05**: KatapultCheckResult dataclass with tri-state result (True/False/None) and error message

### TUI Integration

- [ ] **TUI-01**: "K" key action in device config screen triggers Katapult check for the currently selected device
- [ ] **TUI-02**: Warning message displayed before check explaining device will briefly enter bootloader mode
- [ ] **TUI-03**: Confirmation prompt gates the check (default: No)
- [ ] **TUI-04**: Clear result display — Katapult detected / not detected / inconclusive with context
- [ ] **TUI-05**: Klipper service stopped before check, guaranteed restart after (uses existing context manager)

### Helper Functions

- [ ] **HELP-01**: _resolve_usb_sysfs_path() resolves /dev/serial/by-id/ symlink to sysfs USB device path
- [ ] **HELP-02**: _usb_sysfs_reset() toggles sysfs authorized flag for USB device recovery (requires sudo)
- [ ] **HELP-03**: _poll_for_serial_device() polls /dev/serial/by-id/ for device matching prefix + serial substring

## Future Requirements

### Deferred

- **CLI --check-katapult flag** — TUI-only for now; CLI flag can be added if scripting use case emerges
- **Multi-device batch check** — Single device from config screen sufficient; batch check adds complexity
- **Pre-flash Katapult auto-detection** — check_katapult() is reusable; wire into flash workflow later

## Out of Scope

| Feature | Reason |
|---------|--------|
| CAN bus Katapult detection | USB only — CAN uses different query mechanism (flashtool.py -q) |
| Katapult installation/flashing | Separate workflow, out of scope for detection feature |
| Double-tap reset detection | Hardware-specific, not programmable from software |
| Persistent Katapult status caching | Status can change between checks, caching would be stale |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| RES-01 | Phase 21 | Pending |
| RES-02 | Phase 21 | Pending |
| RES-03 | Phase 21 | Pending |
| RES-04 | Phase 21 | Pending |
| RES-05 | Phase 21 | Pending |
| DET-01 | Phase 22 | Pending |
| DET-02 | Phase 22 | Pending |
| DET-03 | Phase 22 | Pending |
| DET-04 | Phase 22 | Pending |
| DET-05 | Phase 22 | Pending |
| HELP-01 | Phase 22 | Pending |
| HELP-02 | Phase 22 | Pending |
| HELP-03 | Phase 22 | Pending |
| TUI-01 | Phase 23 | Pending |
| TUI-02 | Phase 23 | Pending |
| TUI-03 | Phase 23 | Pending |
| TUI-04 | Phase 23 | Pending |
| TUI-05 | Phase 23 | Pending |

**Coverage:**
- v3.4 requirements: 18 total
- Mapped to phases: 18
- Unmapped: 0

---
*Requirements defined: 2026-01-31*
*Last updated: 2026-01-31 after initial definition*
