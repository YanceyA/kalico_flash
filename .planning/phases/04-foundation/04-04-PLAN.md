---
phase: 04-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - kalico-flash/errors.py
  - kalico-flash/flash.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees numbered recovery steps (1., 2., 3.) on any error"
    - "User can read full error message without horizontal scrolling"
    - "Error messages include context (device name, MCU type, path)"
  artifacts:
    - path: "kalico-flash/errors.py"
      provides: "ERROR_TEMPLATES with numbered recovery steps"
      contains: "1. "
    - path: "kalico-flash/flash.py"
      provides: "All error paths use error_with_recovery()"
      pattern: "error_with_recovery"
  key_links:
    - from: "kalico-flash/flash.py"
      to: "output.py error_with_recovery()"
      via: "out.error_with_recovery() calls"
      pattern: "out\\.error_with_recovery\\("
    - from: "kalico-flash/flash.py"
      to: "errors.py ERROR_TEMPLATES"
      via: "import statement"
      pattern: "from errors import.*ERROR_TEMPLATES"
---

<objective>
Close verification gap: Integrate error framework into flash.py error paths

The error message framework (format_error, ERROR_TEMPLATES, error_with_recovery) was built
in Plan 04-01 but only 1 of 40 error paths uses it. This plan wires the framework into all
flash.py error paths and converts ERROR_TEMPLATES recovery text to numbered steps.

Purpose: Users hitting any error see numbered recovery steps with diagnostic commands
Output: All flash.py errors use error_with_recovery() with context and numbered recovery
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-foundation/04-01-SUMMARY.md
@.planning/phases/04-foundation/04-VERIFICATION.md

# Source files
@kalico-flash/errors.py
@kalico-flash/flash.py
@kalico-flash/output.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert ERROR_TEMPLATES recovery text to numbered steps</name>
  <files>kalico-flash/errors.py</files>
  <action>
Update all ERROR_TEMPLATES recovery_template values to use numbered steps instead of prose
paragraphs. Each template should have 3-5 numbered recovery steps.

Format pattern for each recovery_template:
```
"1. First recovery action with specific command\n"
"2. Second recovery action\n"
"3. Third recovery action with diagnostic command"
```

Specific conversions needed:

build_failed:
1. Check the build output above for the specific error message
2. Run `make menuconfig` in ~/klipper to verify configuration
3. Ensure toolchain is installed: `arm-none-eabi-gcc --version`
4. Clean and retry: `cd ~/klipper && make clean && make`

menuconfig_failed:
1. Install ncurses: `sudo apt install libncurses-dev`
2. Verify Klipper directory exists: `ls ~/klipper/Makefile`
3. Try running menuconfig directly: `cd ~/klipper && make menuconfig`

device_not_registered:
1. List registered devices: `python flash.py --list-devices`
2. Register new device: `python flash.py --add-device`
3. Check device key spelling (case-sensitive)

device_not_connected:
1. Check USB connection and board power
2. List connected devices: `ls /dev/serial/by-id/`
3. If device shows with different name, re-register with `--add-device`

mcu_mismatch:
1. Run without --skip-menuconfig to reconfigure
2. Or update device registration if MCU changed
3. Verify config: `grep CONFIG_MCU ~/klipper/.config`

service_stop_failed:
1. Check service status: `sudo systemctl status klipper`
2. Verify passwordless sudo: `sudo -n systemctl stop klipper`
3. Try manual stop: `sudo systemctl stop klipper`

service_start_failed:
1. Start manually: `sudo systemctl start klipper`
2. Check logs: `sudo journalctl -u klipper -n 50`
3. Firmware was flashed - issue is service, not board

flash_failed:
1. Power cycle the board with BOOT button held
2. Check bootloader mode: `ls /dev/serial/by-id/ | grep -i katapult`
3. For DFU mode, check: `lsusb | grep -i stm32`
4. Retry flash after board enters bootloader

katapult_not_found:
1. Falling back to make flash method
2. To use Katapult, install at ~/katapult
3. Verify: `ls ~/katapult/scripts/flashtool.py`

device_excluded:
1. Include device: `python flash.py --include-device {device}`
2. List all devices: `python flash.py --list-devices`
3. Device was excluded to prevent accidental flash

moonraker_unavailable:
1. Check Moonraker status: `sudo systemctl status moonraker`
2. Restart Moonraker: `sudo systemctl restart moonraker`
3. Verify API: `curl http://localhost:7125/server/info`
4. Flash proceeds without print status check if unavailable

printer_busy:
1. Wait for current print/operation to complete
2. Check printer status in Fluidd/Mainsail dashboard
3. Use `--force` flag only if safe to interrupt operation
4. Cancel print first if flashing is urgent
  </action>
  <verify>
Run: `python -c "from errors import ERROR_TEMPLATES; print(ERROR_TEMPLATES['build_failed']['recovery_template'])"`
Output should show numbered steps (1., 2., 3.) not prose paragraphs.
  </verify>
  <done>All 12 ERROR_TEMPLATES have recovery_template with numbered steps (1., 2., 3. format)</done>
</task>

<task type="auto">
  <name>Task 2a: Convert Build/Config errors to error_with_recovery()</name>
  <files>kalico-flash/flash.py</files>
  <action>
Add ERROR_TEMPLATES import and convert Build/Config error paths to use error_with_recovery().

**Import (add to flash.py imports around line 30):**
```python
from errors import ERROR_TEMPLATES
```

**Line 146 (cmd_build menuconfig exit):**
Replace:
```python
out.error(f"menuconfig exited with code {ret_code}")
```
With:
```python
template = ERROR_TEMPLATES["menuconfig_failed"]
out.error_with_recovery(
    template["error_type"],
    template["message_template"],
    context={"device": device_key},
    recovery=template["recovery_template"],
)
```

**Line 160 (cmd_build cache config failure):**
Replace:
```python
out.error(f"Failed to cache config: {e}")
```
With:
```python
out.error_with_recovery(
    "Config error",
    f"Failed to cache config: {e}",
    context={"device": device_key},
    recovery="1. Verify Klipper directory is writable\n2. Check disk space\n3. Re-run menuconfig",
)
```

**Lines 167-172 (cmd_build MCU mismatch - 2 out.error calls):**
Replace both:
```python
out.error(f"MCU mismatch: config has '{actual_mcu}' but device '{device_key}' expects '{entry.mcu}'")
out.error("Refusing to build wrong firmware. Fix .config and try again.")
```
With single call:
```python
template = ERROR_TEMPLATES["mcu_mismatch"]
out.error_with_recovery(
    template["error_type"],
    template["message_template"].format(actual=actual_mcu, expected=entry.mcu),
    context={"device": device_key, "expected": entry.mcu, "actual": actual_mcu},
    recovery=template["recovery_template"],
)
```

**Line 175 (cmd_build MCU validation):**
Replace:
```python
out.error(f"MCU validation failed: {e}")
```
With:
```python
out.error_with_recovery(
    "Config error",
    f"MCU validation failed: {e}",
    context={"device": device_key},
    recovery="1. Run menuconfig and verify MCU selection\n2. Check .config file exists\n3. Ensure CONFIG_MCU is set",
)
```

**Line 183 (cmd_build build failed):**
Replace:
```python
out.error(f"Build failed: {result.error_message}")
```
With:
```python
template = ERROR_TEMPLATES["build_failed"]
out.error_with_recovery(
    template["error_type"],
    template["message_template"].format(device=device_key),
    context={"device": device_key},
    recovery=template["recovery_template"],
)
```

**Line 358 (cmd_flash menuconfig exit):**
Same pattern as line 146 with menuconfig_failed template.

**Line 372 (cmd_flash cache config failure):**
Same pattern as line 160.

**Lines 379-384 (cmd_flash MCU mismatch - 2 out.error calls):**
Same pattern as lines 167-172, merge into single error_with_recovery call.

**Line 387 (cmd_flash MCU validation):**
Same pattern as line 175.

**Lines 395-396 (cmd_flash build failed - 2 out.error calls):**
Replace both:
```python
out.error(f"Build failed: {build_result.error_message}")
out.error("Recovery: Check build output above for errors.")
```
With single call using build_failed template.

**Total: 12 out.error calls converted to 8 out.error_with_recovery calls**
  </action>
  <verify>
Run: `grep "from errors import.*ERROR_TEMPLATES" kalico-flash/flash.py`
Should show the import statement.

Run: `python -c "import flash"` (no syntax errors)
  </verify>
  <done>Build/Config errors in cmd_build and cmd_flash use error_with_recovery() with appropriate templates</done>
</task>

<task type="auto">
  <name>Task 2b: Convert Device errors to error_with_recovery()</name>
  <files>kalico-flash/flash.py</files>
  <action>
Convert Device-related error paths to use error_with_recovery() with device templates.

**Line 120 (cmd_build device not found):**
Replace:
```python
out.error(f"Device '{device_key}' not found.")
```
With:
```python
template = ERROR_TEMPLATES["device_not_registered"]
out.error_with_recovery(
    template["error_type"],
    template["message_template"].format(device=device_key),
    context={"device": device_key},
    recovery=template["recovery_template"],
)
```

**Line 248 (cmd_flash no registered devices connected):**
Replace:
```python
out.error("No registered devices connected.")
```
With:
```python
out.error_with_recovery(
    "Device not found",
    "No registered devices connected",
    recovery="1. List registered devices: python flash.py --list-devices\n2. Check USB connections\n3. Register new device: python flash.py --add-device",
)
```

**Line 266 (cmd_flash no flashable devices):**
Replace:
```python
out.error("No flashable devices connected. All connected devices are excluded.")
```
With:
```python
template = ERROR_TEMPLATES["device_excluded"]
out.error_with_recovery(
    template["error_type"],
    "All connected devices are excluded from flashing",
    recovery=template["recovery_template"],
)
```

**Line 304 (cmd_flash device not in registry):**
Replace:
```python
out.error(f"Device '{device_key}' not found in registry.")
```
With:
```python
template = ERROR_TEMPLATES["device_not_registered"]
out.error_with_recovery(
    template["error_type"],
    template["message_template"].format(device=device_key),
    context={"device": device_key},
    recovery=template["recovery_template"],
)
```

**Line 321 (cmd_flash device not connected):**
Replace:
```python
out.error(f"Device '{device_key}' is not connected.")
```
With:
```python
template = ERROR_TEMPLATES["device_not_connected"]
out.error_with_recovery(
    template["error_type"],
    template["message_template"].format(device=device_key),
    context={"device": device_key},
    recovery=template["recovery_template"],
)
```

**Line 454 (cmd_remove_device not found):**
Replace:
```python
out.error(f"Device '{device_key}' not found in registry")
```
With:
```python
template = ERROR_TEMPLATES["device_not_registered"]
out.error_with_recovery(
    template["error_type"],
    template["message_template"].format(device=device_key),
    context={"device": device_key},
    recovery=template["recovery_template"],
)
```

**Line 489 (cmd_exclude_device not found):**
Same pattern as line 454 with device_not_registered template.

**Line 503 (cmd_include_device not found):**
Same pattern as line 454 with device_not_registered template.

**Total: 8 out.error calls converted to 8 out.error_with_recovery calls**
  </action>
  <verify>
Run: `grep -c "device_not_registered\|device_not_connected\|device_excluded" kalico-flash/flash.py`
Should show >= 6 template references.

Run: `python -c "import flash"` (no syntax errors)
  </verify>
  <done>Device-related errors use error_with_recovery() with device_not_registered/device_not_connected/device_excluded templates</done>
</task>

<task type="auto">
  <name>Task 2c: Convert Flash/Service errors to error_with_recovery()</name>
  <files>kalico-flash/flash.py</files>
  <action>
Convert Flash and Service error paths to use error_with_recovery() with flash/service templates.

**Lines 408-409 (cmd_flash device disconnected - DiscoveryError handler):**
Replace:
```python
out.error(str(e))
out.error("Recovery: Reconnect the device and try again.")
```
With single call:
```python
out.error_with_recovery(
    "Device disconnected",
    str(e),
    context={"device": device_key, "path": device_path},
    recovery="1. Check USB connection and board power\n2. List devices: ls /dev/serial/by-id/\n3. Reconnect and retry flash",
)
```

**Lines 431-432 (cmd_flash operation error - Exception handler):**
Replace:
```python
out.error(f"Flash operation error: {e}")
out.error("Recovery: Power cycle the board and try again.")
```
With single call:
```python
template = ERROR_TEMPLATES["flash_failed"]
out.error_with_recovery(
    template["error_type"],
    f"Flash operation error: {e}",
    context={"device": device_key},
    recovery=template["recovery_template"],
)
```

**Lines 444-446 (cmd_flash flash failed - FlashResult failure):**
Replace:
```python
out.error(f"Flash failed: {flash_result.error_message}")
out.error(f"Method attempted: {flash_result.method}")
out.error("Recovery: Power cycle the board and try again.")
```
With single call:
```python
template = ERROR_TEMPLATES["flash_failed"]
out.error_with_recovery(
    template["error_type"],
    template["message_template"].format(device=device_key),
    context={"device": device_key, "method": flash_result.method, "error": flash_result.error_message},
    recovery=template["recovery_template"],
)
```

**Simple errors to KEEP as out.error() (no changes needed):**
- Line 225: "Interactive terminal required" - user info
- Line 231: "Global config not set" - simple instruction
- Line 241: "No USB devices found" - simple action
- Line 298: "Too many invalid selections" - user input
- Line 583: "Interactive terminal required" - user info
- Line 590: "No USB devices found" - simple action
- Line 610, 642, 693: "Too many invalid inputs" - user input
- Line 662: "MCU type is required" - user input
- Line 751, 754: Generic exception fallback - catch-all

**Total: 7 out.error calls converted to 3 out.error_with_recovery calls**
  </action>
  <verify>
Run: `grep -c "out.error_with_recovery" kalico-flash/flash.py`
Should show 19 total (8 build/config + 8 device + 3 flash/service).

Run: `grep -c "out.error(" kalico-flash/flash.py`
Should show ~12 remaining simple out.error() calls.

Run: `python -c "import flash"` (no syntax errors)
  </verify>
  <done>Flash/Service errors use error_with_recovery() with flash_failed template, 12 simple errors remain as out.error()</done>
</task>

</tasks>

<verification>
1. All 12 ERROR_TEMPLATES have numbered recovery steps (1., 2., 3. format)
2. Verify import: `grep "from errors import.*ERROR_TEMPLATES" kalico-flash/flash.py` returns match
3. Count: `grep -c "out.error_with_recovery" kalico-flash/flash.py` shows >= 19 calls
4. No Python syntax errors: `python -c "import flash; from errors import ERROR_TEMPLATES"`
5. Remaining simple errors: `grep -c "out.error(" kalico-flash/flash.py` shows ~12
</verification>

<success_criteria>
- All 12 ERROR_TEMPLATES (including moonraker_unavailable, printer_busy) have numbered recovery steps
- flash.py imports ERROR_TEMPLATES from errors module
- Build/Config errors (8 sites) use error_with_recovery() with appropriate templates
- Device errors (8 sites) use error_with_recovery() with device templates
- Flash/Service errors (3 sites) use error_with_recovery() with flash templates
- Simple user-input errors (~12 sites) remain as out.error()
- Python imports work: `python -c "import flash; from errors import ERROR_TEMPLATES"`
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation/04-04-SUMMARY.md`
</output>
