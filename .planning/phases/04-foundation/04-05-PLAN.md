---
phase: 04-foundation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - kalico-flash/service.py
  - kalico-flash/config.py
  - kalico-flash/flasher.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "ServiceError messages use ERROR_TEMPLATES with numbered recovery steps"
    - "ConfigError messages include context about what failed"
    - "DiscoveryError messages include diagnostic commands"
  artifacts:
    - path: "kalico-flash/service.py"
      provides: "ServiceError raised with ERROR_TEMPLATES"
      pattern: "ERROR_TEMPLATES\\[.service_"
    - path: "kalico-flash/config.py"
      provides: "ConfigError raised with context"
      pattern: "format_error"
    - path: "kalico-flash/flasher.py"
      provides: "DiscoveryError raised with format_error() message"
      pattern: "format_error"
  key_links:
    - from: "kalico-flash/service.py"
      to: "errors.py ERROR_TEMPLATES"
      via: "import and 5 uses (2 raises + 3 warnings)"
      pattern: "from errors import.*ERROR_TEMPLATES"
    - from: "kalico-flash/config.py"
      to: "errors.py format_error()"
      via: "import and call at lines 114, 135, 141 (3 raises)"
      pattern: "from errors import.*format_error"
    - from: "kalico-flash/flasher.py"
      to: "errors.py format_error()"
      via: "import and call at line 26 (1 raise)"
      pattern: "from errors import.*format_error"
---

<objective>
Close verification gap: Integrate error formatting into supporting modules

Supporting modules (service.py, config.py, flasher.py) raise exceptions with plain messages.
This plan updates them to use format_error() for consistent, informative error messages.

Purpose: Exceptions raised from supporting modules include context and recovery guidance
Output: All exception raises use format_error() to build the message string
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-foundation/04-01-SUMMARY.md
@.planning/phases/04-foundation/04-VERIFICATION.md

# Source files
@kalico-flash/errors.py
@kalico-flash/service.py
@kalico-flash/config.py
@kalico-flash/flasher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update service.py to use format_error() with ERROR_TEMPLATES</name>
  <files>kalico-flash/service.py</files>
  <action>
Import format_error and ERROR_TEMPLATES from errors module. Use templates for consistent messaging.

**Update imports (line 8):**
```python
from errors import ServiceError, format_error, ERROR_TEMPLATES
```

**Raise site 1 - Line 51 (_stop_klipper failure):**
Replace:
```python
raise ServiceError(f"Failed to stop Klipper: {result.stderr.strip()}")
```
With:
```python
template = ERROR_TEMPLATES["service_stop_failed"]
msg = format_error(
    template["error_type"],
    template["message_template"],
    context={"stderr": result.stderr.strip()},
    recovery=template["recovery_template"],
)
raise ServiceError(msg)
```

**Raise site 2 - Line 53 (_stop_klipper timeout):**
Replace:
```python
raise ServiceError(f"Timeout ({timeout}s) stopping Klipper service")
```
With:
```python
template = ERROR_TEMPLATES["service_stop_failed"]
msg = format_error(
    template["error_type"],
    f"Timeout ({timeout}s) stopping Klipper service",
    recovery=template["recovery_template"],
)
raise ServiceError(msg)
```

**Warning site 1 - Lines 72-74 (_start_klipper failure):**
Replace:
```python
if result.returncode != 0:
    print(f"[Warning] Failed to restart Klipper: {result.stderr.strip()}")
    print("[Warning] Run 'sudo systemctl start klipper' manually.")
```
With:
```python
if result.returncode != 0:
    template = ERROR_TEMPLATES["service_start_failed"]
    print(format_error(
        template["error_type"],
        template["message_template"],
        context={"stderr": result.stderr.strip()},
        recovery=template["recovery_template"],
    ))
```

**Warning site 2 - Lines 75-77 (_start_klipper timeout):**
Replace:
```python
except subprocess.TimeoutExpired:
    print(f"[Warning] Timeout ({timeout}s) starting Klipper service")
    print("[Warning] Run 'sudo systemctl start klipper' manually.")
```
With:
```python
except subprocess.TimeoutExpired:
    template = ERROR_TEMPLATES["service_start_failed"]
    print(format_error(
        template["error_type"],
        f"Timeout ({timeout}s) starting Klipper service",
        recovery=template["recovery_template"],
    ))
```

**Warning site 3 - Lines 78-80 (_start_klipper exception):**
Replace:
```python
except Exception as e:
    print(f"[Warning] Error starting Klipper: {e}")
    print("[Warning] Run 'sudo systemctl start klipper' manually.")
```
With:
```python
except Exception as e:
    template = ERROR_TEMPLATES["service_start_failed"]
    print(format_error(
        template["error_type"],
        f"Error starting Klipper: {e}",
        recovery=template["recovery_template"],
    ))
```

Note: _start_klipper prints warnings rather than raising (by design, to not mask
the original error). Keep this behavior but use format_error + ERROR_TEMPLATES for consistency.

**Total: 2 raise sites + 3 warning sites = 5 format_error calls using ERROR_TEMPLATES**
  </action>
  <verify>
Run: `python -c "import service"` (no syntax errors)
Run: `grep "ERROR_TEMPLATES" kalico-flash/service.py` (shows import and 5 uses)
Run: `grep -c "format_error" kalico-flash/service.py` (shows 5 calls)
  </verify>
  <done>service.py uses ERROR_TEMPLATES["service_stop_failed"] and ERROR_TEMPLATES["service_start_failed"] for all error messages</done>
</task>

<task type="auto">
  <name>Task 2: Update config.py to use format_error() for ConfigError</name>
  <files>kalico-flash/config.py</files>
  <action>
Import format_error from errors and use it when raising ConfigError.

**Raise sites to update:**
- Line 114: `raise ConfigError(f"No .config file in klipper directory: {self.klipper_dir}")` (in save_cached_config)
- Line 135: `raise ConfigError(f"No .config file in klipper directory: {self.klipper_dir}")` (in validate_mcu)
- Line 141: `raise ConfigError(f"No CONFIG_MCU found in .config: {self.klipper_config_path}")` (in validate_mcu)

Update imports:
```python
from errors import ConfigError, format_error
```

In save_cached_config() (line 114), replace:
```python
raise ConfigError(
    f"No .config file in klipper directory: {self.klipper_dir}"
)
```
With:
```python
msg = format_error(
    "Config error",
    "No .config file found after menuconfig",
    context={"path": str(self.klipper_dir)},
    recovery=(
        "1. Run make menuconfig first\n"
        "2. Save config before exiting menuconfig\n"
        "3. Check path: ls {klipper_dir}/.config"
    ).format(klipper_dir=self.klipper_dir),
)
raise ConfigError(msg)
```

In validate_mcu() for missing .config (line 135), replace:
```python
raise ConfigError(
    f"No .config file in klipper directory: {self.klipper_dir}"
)
```
With:
```python
msg = format_error(
    "Config error",
    "No .config file for MCU validation",
    context={"path": str(self.klipper_dir)},
    recovery=(
        "1. Run make menuconfig to create .config\n"
        "2. Or use --skip-menuconfig with existing cached config\n"
        "3. Check: ls {klipper_dir}/.config"
    ).format(klipper_dir=self.klipper_dir),
)
raise ConfigError(msg)
```

In validate_mcu() for missing CONFIG_MCU (line 141), replace:
```python
raise ConfigError(
    f"No CONFIG_MCU found in .config: {self.klipper_config_path}"
)
```
With:
```python
msg = format_error(
    "Config error",
    "No CONFIG_MCU found in .config file",
    context={"path": str(self.klipper_config_path)},
    recovery=(
        "1. Run make menuconfig and select MCU type\n"
        "2. Save config before exiting\n"
        "3. Verify: grep CONFIG_MCU {config_path}"
    ).format(config_path=self.klipper_config_path),
)
raise ConfigError(msg)
```
  </action>
  <verify>
Run: `python -c "import config"` (no syntax errors)
Run: `grep "format_error" kalico-flash/config.py` (shows 3 uses)
  </verify>
  <done>config.py raises ConfigError with formatted messages including path context and recovery steps</done>
</task>

<task type="auto">
  <name>Task 3: Update flasher.py to use format_error() for DiscoveryError</name>
  <files>kalico-flash/flasher.py</files>
  <action>
Import format_error from errors and use it when raising DiscoveryError.

**Raise site to update:**
- Line 26: `raise DiscoveryError(f"Device no longer connected: {device_path}\n" ...)` (in verify_device_path)

Update imports:
```python
from errors import DiscoveryError, format_error
```

In verify_device_path() (line 26), replace:
```python
raise DiscoveryError(
    f"Device no longer connected: {device_path}\n"
    "The device may have been unplugged during build."
)
```
With:
```python
msg = format_error(
    "Device disconnected",
    "Device no longer connected after build",
    context={"path": device_path},
    recovery=(
        "1. Check USB cable connection\n"
        "2. Verify board power LED is on\n"
        "3. List devices: ls /dev/serial/by-id/\n"
        "4. Reconnect and retry flash"
    ),
)
raise DiscoveryError(msg)
```

The _try_katapult_flash and _try_make_flash functions return FlashResult rather than
raising exceptions. Their error_message field is already a plain string. The calling
code in flash.py (Plan 04-04) will wrap these in error_with_recovery(). No changes needed
to the FlashResult error_message fields.
  </action>
  <verify>
Run: `python -c "import flasher"` (no syntax errors)
Run: `grep "format_error" kalico-flash/flasher.py` (shows 1 use)
  </verify>
  <done>flasher.py raises DiscoveryError with formatted message including device path and recovery steps</done>
</task>

</tasks>

<verification>
1. All three modules import format_error from errors
2. All exception raises use format_error() to build message
3. No Python syntax errors in any module
4. Test imports: `python -c "import service; import config; import flasher"`
</verification>

<success_criteria>
- service.py uses ERROR_TEMPLATES["service_stop_failed"] for 2 raise sites
- service.py uses ERROR_TEMPLATES["service_start_failed"] for 3 warning sites
- config.py uses format_error() for all 3 ConfigError raises
- flasher.py uses format_error() for the DiscoveryError raise
- All modules pass Python syntax check: `python -c "import service; import config; import flasher"`
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation/04-05-SUMMARY.md`
</output>
