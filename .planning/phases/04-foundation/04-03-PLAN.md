---
phase: 04-foundation
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - kalico-flash/flash.py
  - kalico-flash/discovery.py
autonomous: true

must_haves:
  truths:
    - "User can run kflash --device octopus-pro -s and skip menuconfig when cached config exists"
    - "User sees helpful message when running -s without cached config, then menuconfig launches"
    - "User can exclude/include devices via --exclude-device and --include-device flags"
    - "Excluded devices appear in --list-devices with [excluded] marker"
    - "Excluded devices cannot be selected in interactive mode"
    - "Explicit --device on excluded device shows error and exits"
    - "--add-device wizard asks if device is flashable"
  artifacts:
    - path: "kalico-flash/flash.py"
      provides: "CLI with -s, -d, --exclude-device, --include-device flags and skip-menuconfig logic"
      contains: "--skip-menuconfig"
    - path: "kalico-flash/discovery.py"
      provides: "Filtered device lists excluding non-flashable devices"
      contains: "flashable"
  key_links:
    - from: "kalico-flash/flash.py"
      to: "kalico-flash/config.py"
      via: "has_cached_config() call for skip-menuconfig"
      pattern: "has_cached_config"
    - from: "kalico-flash/flash.py"
      to: "kalico-flash/registry.py"
      via: "set_flashable() for exclude/include commands"
      pattern: "set_flashable"
    - from: "kalico-flash/flash.py"
      to: "kalico-flash/errors.py"
      via: "ExcludedDeviceError for blocked flash attempts"
      pattern: "ExcludedDeviceError"
---

<objective>
Implement skip-menuconfig flag and device exclusion CLI commands.

Purpose: Power users can bypass menuconfig with -s flag. Devices like Beacon probes can be excluded from flash selection. All error scenarios use the new error framework.

Output: Updated flash.py with new flags and logic, updated discovery.py with exclusion filtering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-foundation/04-CONTEXT.md
@.planning/phases/04-foundation/04-RESEARCH.md
@.planning/phases/04-foundation/04-01-SUMMARY.md
@.planning/phases/04-foundation/04-02-SUMMARY.md
@kalico-flash/flash.py
@kalico-flash/discovery.py
@kalico-flash/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI flags for skip-menuconfig and device exclusion</name>
  <files>kalico-flash/flash.py</files>
  <action>
Update build_parser() to add new flags:

1. Add -s/--skip-menuconfig flag:
   ```python
   parser.add_argument(
       "-s", "--skip-menuconfig",
       action="store_true",
       help="Skip menuconfig if cached config exists",
   )
   ```

2. Add -d short flag to existing --device:
   ```python
   parser.add_argument(
       "-d", "--device",  # Add -d short form
       metavar="KEY",
       help="Device key to build and flash (run without --device for interactive selection)",
   )
   ```

3. Add --exclude-device and --include-device flags (NOT mutually exclusive with each other or management group):
   ```python
   parser.add_argument(
       "--exclude-device",
       metavar="KEY",
       help="Mark a device as non-flashable",
   )
   parser.add_argument(
       "--include-device",
       metavar="KEY",
       help="Mark a device as flashable",
   )
   ```

4. Update epilog to mention -s flag:
   ```python
   epilog="Run without args for interactive device selection, or use -d KEY "
          "to flash a specific board. Use -s to skip menuconfig when cached config exists. "
          "Device management: --add-device, --list-devices, --remove-device, "
          "--exclude-device, --include-device.",
   ```
  </action>
  <verify>
Run: python kalico-flash/flash.py --help

Output should show -s/--skip-menuconfig, -d/--device, --exclude-device, --include-device flags.
  </verify>
  <done>All new CLI flags added to argument parser with correct help text</done>
</task>

<task type="auto">
  <name>Task 2: Implement skip-menuconfig logic in cmd_flash()</name>
  <files>kalico-flash/flash.py</files>
  <action>
Update cmd_flash() to handle --skip-menuconfig:

1. Add skip_menuconfig parameter to cmd_flash() signature:
   ```python
   def cmd_flash(registry, device_key, out, skip_menuconfig: bool = False) -> int:
   ```

2. In the Config phase section (around line 291-310), replace the menuconfig block with:
   ```python
   # === Phase 2: Config ===
   out.phase("Config", f"Loading config for {entry.name}...")
   config_mgr = ConfigManager(device_key, klipper_dir)

   if config_mgr.load_cached_config():
       out.phase("Config", f"Loaded cached config for '{device_key}'")
   else:
       out.phase("Config", "No cached config found, starting fresh")

   # Skip menuconfig if flag is set AND cached config exists
   if skip_menuconfig:
       if config_mgr.has_cached_config():
           out.phase("Config", f"Using cached config for {device_key}")
           # Skip menuconfig but still validate MCU
       else:
           # Per CONTEXT.md: warn and launch menuconfig anyway
           out.warn(f"No cached config for '{device_key}', launching menuconfig")
           skip_menuconfig = False  # Fall through to menuconfig

   if not skip_menuconfig:
       out.phase("Config", "Launching menuconfig...")
       ret_code, was_saved = run_menuconfig(klipper_dir, str(config_mgr.klipper_config_path))

       if ret_code != 0:
           out.error(f"menuconfig exited with code {ret_code}")
           return 1

       if not was_saved:
           out.warn("Config was not saved in menuconfig")
           if not out.confirm("Continue build anyway?"):
               out.phase("Config", "Cancelled")
               return 0

       # Save config to cache
       try:
           config_mgr.save_cached_config()
           out.phase("Config", f"Cached config for '{device_key}'")
       except ConfigError as e:
           out.error(f"Failed to cache config: {e}")
           return 1
   ```

3. MCU validation ALWAYS runs (after the if/else block) - per CONTEXT.md decision.

4. Update the main() call to pass skip_menuconfig:
   ```python
   return cmd_flash(registry, args.device, out, skip_menuconfig=args.skip_menuconfig)
   ```
  </action>
  <verify>
Verify syntax: python -m py_compile kalico-flash/flash.py

Test help shows -s flag correctly.
  </verify>
  <done>cmd_flash() handles --skip-menuconfig flag, warns if no cache, always validates MCU</done>
</task>

<task type="auto">
  <name>Task 3: Implement device exclusion commands and filtering</name>
  <files>kalico-flash/flash.py, kalico-flash/discovery.py</files>
  <action>
**In flash.py:**

1. Add cmd_exclude_device() function:
   ```python
   def cmd_exclude_device(registry, device_key: str, out) -> int:
       """Mark a device as non-flashable."""
       entry = registry.get(device_key)
       if entry is None:
           out.error(f"Device '{device_key}' not found in registry")
           return 1
       if not entry.flashable:
           out.warn(f"Device '{device_key}' is already excluded")
           return 0
       registry.set_flashable(device_key, False)
       out.success(f"Excluded '{device_key}' from flashing")
       return 0
   ```

2. Add cmd_include_device() function:
   ```python
   def cmd_include_device(registry, device_key: str, out) -> int:
       """Mark a device as flashable."""
       entry = registry.get(device_key)
       if entry is None:
           out.error(f"Device '{device_key}' not found in registry")
           return 1
       if entry.flashable:
           out.warn(f"Device '{device_key}' is already flashable")
           return 0
       registry.set_flashable(device_key, True)
       out.success(f"Included '{device_key}' for flashing")
       return 0
   ```

3. Update main() to handle new flags (before the flash workflow):
   ```python
   if args.exclude_device:
       return cmd_exclude_device(registry, args.exclude_device, out)
   elif args.include_device:
       return cmd_include_device(registry, args.include_device, out)
   ```

4. Update cmd_list_devices() to show [excluded] marker:
   ```python
   # In the display loop:
   if key in connected_map:
       device = connected_map[key]
       marker = "OK"
       status = device.path
   else:
       marker = "--"
       status = "(disconnected)"

   # Add exclusion indicator
   if not entry.flashable:
       out.device_line(marker, f"{entry.key}: {entry.name} ({entry.mcu}) [excluded]", status)
   else:
       out.device_line(marker, f"{entry.key}: {entry.name} ({entry.mcu})", status)
   ```

5. Update cmd_flash() interactive selection to filter excluded devices:
   - After find_registered_devices(), filter to flashable only for selection
   - Show excluded devices with note but don't allow selection
   - Per CONTEXT.md: excluded shown but disabled, cannot be selected

6. Update cmd_flash() explicit --device path to check flashable:
   ```python
   # After registry.get(device_key):
   if not entry.flashable:
       from errors import ExcludedDeviceError
       out.error_with_recovery(
           "Device excluded",
           device_key,
           {"device": device_key, "name": entry.name},
           f"The device '{device_key}' is marked as non-flashable. "
           f"To make it flashable, run `python flash.py --include-device {device_key}`."
       )
       return 1
   ```

7. Update cmd_add_device() to ask if device is flashable (after Step 7, before Step 8):
   ```python
   # Step 7.5: Ask if flashable
   is_flashable = out.confirm("Is this device flashable?", default=True)
   ```
   And update the DeviceEntry creation to include flashable=is_flashable.

**In discovery.py:**

8. Update find_registered_devices() docstring to note it returns all devices, including non-flashable. The filtering happens in flash.py at selection time.
  </action>
  <verify>
1. Syntax check: python -m py_compile kalico-flash/flash.py kalico-flash/discovery.py
2. Help check: python kalico-flash/flash.py --help (shows --exclude-device, --include-device)
3. Import check: python -c "from flash import cmd_exclude_device, cmd_include_device"
  </verify>
  <done>Exclusion commands work, --list-devices shows [excluded], interactive selection filters excluded, explicit --device on excluded errors</done>
</task>

</tasks>

<verification>
1. Full syntax check: `python -m py_compile kalico-flash/flash.py kalico-flash/discovery.py`
2. Help output: `python kalico-flash/flash.py --help` shows all new flags
3. Live test on Pi (if available):
   - Register test device
   - Run `--exclude-device test-device`
   - Run `--list-devices` and verify [excluded] marker
   - Run `--device test-device` and verify error
   - Run `--include-device test-device`
   - Run `--device test-device -s` and verify skip behavior
</verification>

<success_criteria>
- `-s`/`--skip-menuconfig` flag skips menuconfig when cached config exists
- Missing cache with -s warns and launches menuconfig anyway
- MCU validation always runs even with -s
- `--exclude-device KEY` marks device non-flashable
- `--include-device KEY` marks device flashable
- `--list-devices` shows [excluded] marker
- Interactive selection shows but disables excluded devices
- Explicit `--device` on excluded device shows error with recovery guidance
- `--add-device` wizard asks if device is flashable
- All code passes Python syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation/04-03-SUMMARY.md`
</output>
