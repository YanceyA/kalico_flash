---
phase: 26-remove-cli
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - kflash/flash.py
  - kflash/errors.py
autonomous: true

must_haves:
  truths:
    - "Running kflash on a TTY launches TUI directly with no argument parsing"
    - "Running kflash on a non-TTY prints an error message and exits with code 1"
    - "No argparse import or build_parser() function exists in flash.py"
    - "cmd_exclude_device and cmd_include_device are deleted (dead code)"
    - "from_tui and from_menu parameters are removed from cmd_* functions"
    - "errors.py get_recovery_text always returns TUI text, from_tui param removed"
  artifacts:
    - path: "kflash/flash.py"
      provides: "Thin TUI launcher with no CLI parsing"
    - path: "kflash/errors.py"
      provides: "Simplified recovery text (TUI-only)"
  key_links:
    - from: "kflash/flash.py main()"
      to: "kflash/tui.py run_menu()"
      via: "direct call after TTY check"
---

<objective>
Delete all argparse/CLI infrastructure from flash.py, making main() a thin TTY-check + run_menu() launcher. Remove dead CLI-only functions, simplify from_tui/from_menu boolean params throughout.

Purpose: Complete the CLI-to-TUI migration so kflash is a pure TUI application.
Output: Simplified flash.py and errors.py with no CLI artifacts.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-remove-cli/26-CONTEXT.md
@.planning/phases/26-remove-cli/26-RESEARCH.md
@kflash/flash.py
@kflash/errors.py
@kflash/tui.py (for caller audit)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete CLI infrastructure and dead code from flash.py</name>
  <files>kflash/flash.py</files>
  <action>
  1. Delete `import argparse` (line 30).

  2. Delete `build_parser()` function entirely (lines 92-157).

  3. Delete `cmd_exclude_device()` and `cmd_include_device()` functions entirely (lines 1422-1463). These are CLI-only — TUI uses `registry.set_flashable()` directly.

  4. Rewrite `main()` to be a thin launcher (replace lines 2007-2058):
     ```python
     def main() -> int:
         """Main entry point — launch TUI."""
         if not sys.stdin.isatty():
             print("kalico-flash requires an interactive terminal.", file=sys.stderr)
             return 1

         from .errors import KlipperFlashError
         from .output import CliOutput
         from .registry import Registry

         out = CliOutput()
         registry_path = Path(__file__).parent / "devices.json"
         registry = Registry(str(registry_path))

         try:
             from .tui import run_menu
             return run_menu(registry, out)
         except KeyboardInterrupt:
             out.warn("Aborted.")
             return 130
         except KlipperFlashError as e:
             out.error(str(e))
             return 1
         except Exception as e:
             out.error(f"Unexpected error: {e}")
             return 3
     ```

  5. Update the module docstring at the top to remove CLI usage examples and reflect TUI-only operation. Remove all `kflash --flag` examples from the Usage section.

  6. Remove `from_tui` parameter from `cmd_flash()` and `cmd_build()`:
     - In `cmd_build()`: Remove `from_tui: bool = False` param. Replace all `if from_tui` branches with the TUI path (always use TUI hints like "Press A to add a device first.").
     - In `cmd_flash()`: Remove `from_tui: bool = False` param. Replace all `if from_tui` branches with the TUI path. Change `get_recovery_text(..., from_tui)` calls to `get_recovery_text(...)` (will always return TUI text after Task 2). Replace CLI-worded hints: "Use --device KEY" -> remove or reword, "--add-device" -> "Press A to add a device", "run `kflash --include-device`" -> "re-include it from the device list".

  7. Remove `from_menu` parameter from `cmd_list_devices()`:
     - Remove `from_menu: bool = False` param. Always use TUI hint text ("Press A to register a board."). Remove the `if new_unmatched and not from_menu:` guard — just always show the hint (or always suppress, whichever the TUI path was).

  8. Update callers in tui.py: grep for `from_tui=True` and `from_menu=True` in tui.py and remove those keyword arguments since the params no longer exist.

  9. Remove the comment "# Explicit --device KEY mode" (line ~648) and any other CLI-referencing comments.
  </action>
  <verify>
  - `python -c "import ast; ast.parse(open('kflash/flash.py').read())"` succeeds (valid Python)
  - grep for "argparse" in flash.py returns nothing
  - grep for "build_parser" in flash.py returns nothing
  - grep for "cmd_exclude_device\|cmd_include_device" in flash.py returns nothing
  - grep for "from_tui" in flash.py returns nothing
  - grep for "from_menu" in flash.py returns nothing
  - grep for "from_tui" in tui.py returns nothing
  </verify>
  <done>
  flash.py has no argparse, no build_parser, no CLI dispatch in main(), no dead cmd_exclude/cmd_include functions, no from_tui/from_menu parameters. main() is a thin TTY check + run_menu() launcher.
  </done>
</task>

<task type="auto">
  <name>Task 2: Simplify recovery text in errors.py to TUI-only</name>
  <files>kflash/errors.py</files>
  <action>
  1. Merge `_TUI_RECOVERY_OVERRIDES` into the base `ERROR_TEMPLATES` recovery_template values. For each key in `_TUI_RECOVERY_OVERRIDES`, replace the corresponding `recovery_template` in `ERROR_TEMPLATES` with the TUI version.

  2. Delete the `_TUI_RECOVERY_OVERRIDES` dict entirely.

  3. Simplify `get_recovery_text()` — remove `from_tui: bool = False` parameter. The function just returns `ERROR_TEMPLATES[key]["recovery_template"]` directly (no branching).

  4. Update any CLI-worded recovery templates that weren't in the overrides dict. Audit all `recovery_template` values in ERROR_TEMPLATES for references to `--flags` or CLI commands. Replace with TUI equivalents.
  </action>
  <verify>
  - `python -c "import ast; ast.parse(open('kflash/errors.py').read())"` succeeds
  - grep for "_TUI_RECOVERY_OVERRIDES" in errors.py returns nothing
  - grep for "from_tui" in errors.py returns nothing
  - grep for "\-\-device\|--add-device\|--remove-device\|--exclude\|--include" in errors.py returns nothing
  </verify>
  <done>
  errors.py recovery text is TUI-only. No dual CLI/TUI branching. get_recovery_text() has no from_tui parameter.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from kflash import flash; print('import ok')"` — module imports cleanly
2. No "argparse" anywhere in flash.py
3. No "from_tui" or "from_menu" anywhere in kflash/*.py
4. No "_TUI_RECOVERY_OVERRIDES" in errors.py
5. main() function is under 25 lines
6. cmd_exclude_device and cmd_include_device do not exist
</verification>

<success_criteria>
kflash is a pure TUI application with no CLI argument parsing. flash.py main() is a thin launcher that checks for TTY and calls run_menu(). All CLI-only code paths, parameters, and hints are removed.
</success_criteria>

<output>
After completion, create `.planning/phases/26-remove-cli/26-01-SUMMARY.md`
</output>
