---
phase: 05-moonraker-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - kalico-flash/moonraker.py
  - kalico-flash/models.py
autonomous: true

must_haves:
  truths:
    - "get_print_status() returns PrintStatus with state, filename, progress when Moonraker is reachable"
    - "get_print_status() returns None when Moonraker is unreachable (no exception)"
    - "get_mcu_versions() returns dict mapping MCU names to firmware versions"
    - "get_mcu_versions() handles multi-MCU setups (mcu, mcu nhk, mcu linux)"
    - "get_host_klipper_version() runs git describe in Klipper directory"
    - "is_mcu_outdated() returns True when host and MCU versions differ"
  artifacts:
    - path: "kalico-flash/moonraker.py"
      provides: "Moonraker API client with graceful degradation"
      exports: ["PrintStatus", "get_print_status", "get_mcu_versions", "get_host_klipper_version", "is_mcu_outdated"]
    - path: "kalico-flash/models.py"
      provides: "PrintStatus dataclass for cross-module exchange"
      contains: "class PrintStatus"
  key_links:
    - from: "kalico-flash/moonraker.py"
      to: "http://localhost:7125"
      via: "urllib.request.urlopen"
      pattern: "urlopen.*7125"
---

<objective>
Create the Moonraker API client module with all functions needed for print safety checks and version detection.

Purpose: Encapsulate all Moonraker HTTP interactions in a single module, following the hub-and-spoke architecture. All functions return None on failure for graceful degradation.

Output: New moonraker.py module with PrintStatus dataclass, and updated models.py exporting PrintStatus.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-moonraker-integration/05-CONTEXT.md
@.planning/phases/05-moonraker-integration/05-RESEARCH.md
@kalico-flash/models.py
@kalico-flash/errors.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create moonraker.py with print status and version functions</name>
  <files>kalico-flash/moonraker.py</files>
  <action>
Create new moonraker.py module with:

1. Module docstring explaining purpose and graceful degradation pattern
2. Constants: MOONRAKER_URL = "http://localhost:7125", TIMEOUT = 5
3. PrintStatus dataclass with fields:
   - state: str (standby, printing, paused, complete, error, cancelled)
   - filename: Optional[str] (None if no file loaded)
   - progress: float (0.0 to 1.0)
4. get_print_status() -> Optional[PrintStatus]:
   - Query /printer/objects/query?print_stats&virtual_sdcard
   - Parse JSON response navigating through result.status
   - Return None on any error (URLError, HTTPError, JSONDecodeError, KeyError, TimeoutError)
   - Include TimeoutError in exception handling for Python 3.9 compatibility
5. get_mcu_versions() -> Optional[dict]:
   - First query /printer/objects/list to discover MCU objects
   - Filter objects starting with "mcu" or equal to "mcu"
   - Query those objects for mcu_version field
   - Normalize names: "mcu" -> "main", "mcu nhk" -> "nhk"
   - URL-encode spaces in query params (%20)
   - Return None on any error
6. get_host_klipper_version(klipper_dir: str) -> Optional[str]:
   - Run `git describe --always --tags --dirty` with cwd=klipper_dir
   - Use Path(klipper_dir).expanduser() for ~ expansion
   - timeout=5 for subprocess
   - Return None on error (TimeoutExpired, FileNotFoundError, OSError)
7. is_mcu_outdated(host_version: str, mcu_version: str) -> bool:
   - Simple string comparison: if versions differ, return True
   - Strip whitespace before comparing
   - This is informational only - never blocks flash

Follow existing module patterns: from __future__ import annotations, type hints, docstrings.
  </action>
  <verify>
File exists at kalico-flash/moonraker.py with all 4 functions and PrintStatus dataclass.
Run: python -c "from moonraker import PrintStatus, get_print_status, get_mcu_versions, get_host_klipper_version, is_mcu_outdated; print('Import OK')"
  </verify>
  <done>
moonraker.py module created with PrintStatus dataclass and all 4 API functions that return None on failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PrintStatus to models.py for cross-module exchange</name>
  <files>kalico-flash/models.py</files>
  <action>
Add PrintStatus dataclass to models.py for use in cross-module contracts. This duplicates the dataclass from moonraker.py to follow the project's pattern where models.py defines all shared dataclasses.

Add after FlashResult class:

```python
@dataclass
class PrintStatus:
    """Current print job status from Moonraker."""
    state: str              # standby, printing, paused, complete, error, cancelled
    filename: Optional[str] # None if no file loaded
    progress: float         # 0.0 to 1.0
```

Note: moonraker.py will import PrintStatus from models.py to maintain the project's dataclass contract pattern.

Update moonraker.py to import PrintStatus from models instead of defining it locally:
- Remove local PrintStatus definition
- Add: from models import PrintStatus
  </action>
  <verify>
Run: python -c "from models import PrintStatus; p = PrintStatus('standby', None, 0.0); print(f'{p.state}')"
Run: python -c "from moonraker import PrintStatus; print('Import from moonraker OK')"
  </verify>
  <done>
PrintStatus dataclass added to models.py and moonraker.py imports it from models.
  </done>
</task>

</tasks>

<verification>
1. moonraker.py exists with get_print_status, get_mcu_versions, get_host_klipper_version, is_mcu_outdated functions
2. All functions return Optional types and handle errors gracefully (return None, don't raise)
3. PrintStatus dataclass exists in models.py
4. moonraker.py imports PrintStatus from models
5. Python syntax check passes: python -m py_compile kalico-flash/moonraker.py kalico-flash/models.py
</verification>

<success_criteria>
- New moonraker.py module with 4 API functions following graceful degradation pattern
- PrintStatus dataclass in models.py following project conventions
- All functions use stdlib only (urllib.request, json, subprocess, dataclasses)
- 5-second timeout on all network and subprocess operations
- Module imports work without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-moonraker-integration/05-01-SUMMARY.md`
</output>
