---
phase: 05-moonraker-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - kalico-flash/flash.py
  - kalico-flash/errors.py
autonomous: true

must_haves:
  truths:
    - "Flash is blocked when print_stats.state is 'printing' or 'paused'"
    - "User sees 'Print in progress: filename (45%)' when blocked"
    - "Flash proceeds when printer state is standby, complete, cancelled, or error"
    - "User sees warning and Y/N prompt when Moonraker is unreachable"
    - "User sees version table with host and MCU versions before flash"
    - "User sees 'MCU firmware is behind host Klipper' when versions differ"
    - "Version check is informational only - never blocks flash"
    - "Target MCU is marked with asterisk in version table"
  artifacts:
    - path: "kalico-flash/flash.py"
      provides: "Moonraker integration in cmd_flash()"
      contains: "get_print_status"
    - path: "kalico-flash/errors.py"
      provides: "Updated printer_busy template"
      contains: "cannot flash during active print"
  key_links:
    - from: "kalico-flash/flash.py"
      to: "kalico-flash/moonraker.py"
      via: "import and function calls"
      pattern: "from moonraker import"
---

<objective>
Integrate Moonraker safety checks and version display into the flash workflow.

Purpose: Block flash during active prints (SAFE-01 to SAFE-04), warn when Moonraker unavailable (SAFE-05), and show version comparison (VER-01 to VER-07). Insert checks between Phase 1 (Discovery) and Phase 2 (Config) in cmd_flash().

Output: Updated flash.py with Moonraker integration, updated error templates in errors.py.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-moonraker-integration/05-CONTEXT.md
@.planning/phases/05-moonraker-integration/05-RESEARCH.md
@.planning/phases/05-moonraker-integration/05-01-SUMMARY.md
@kalico-flash/flash.py
@kalico-flash/errors.py
@kalico-flash/output.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update error templates for print blocking</name>
  <files>kalico-flash/errors.py</files>
  <action>
Update the printer_busy template in ERROR_TEMPLATES to match CONTEXT.md decisions:

Replace the existing printer_busy template with:
```python
"printer_busy": {
    "error_type": "Printer busy",
    "message_template": "Cannot flash during active print",
    "recovery_template": (
        "1. Wait for current print to complete\n"
        "2. Or cancel print in Fluidd/Mainsail dashboard\n"
        "3. Then re-run flash command"
    ),
},
```

Key changes per CONTEXT.md:
- Remove "--force flag" mention (no force-override per decisions)
- Minimal blocked message: "Cannot flash during active print"
- Recovery focuses on waiting or cancelling

Also update moonraker_unavailable template to match Phase 5 wording:
```python
"moonraker_unavailable": {
    "error_type": "Moonraker unavailable",
    "message_template": "Could not connect to Moonraker API",
    "recovery_template": (
        "1. Check Moonraker status: `sudo systemctl status moonraker`\n"
        "2. Verify API: `curl http://localhost:7125/server/info`\n"
        "3. Proceed with caution - print status check unavailable"
    ),
},
```
  </action>
  <verify>
Run: python -c "from errors import ERROR_TEMPLATES; t = ERROR_TEMPLATES['printer_busy']; assert 'force' not in t['recovery_template'].lower(); print('No force flag mentioned')"
Run: python -c "from errors import ERROR_TEMPLATES; print(ERROR_TEMPLATES['printer_busy']['message_template'])"
  </verify>
  <done>
ERROR_TEMPLATES updated with printer_busy and moonraker_unavailable wording per CONTEXT.md decisions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Moonraker safety check to cmd_flash()</name>
  <files>kalico-flash/flash.py</files>
  <action>
Insert Moonraker print status check in cmd_flash() after Phase 1 Discovery completes but before Phase 2 Config begins.

Location: After line `out.phase("Discovery", f"Target: {entry.name} ({entry.mcu}) at {device_path}")` and before `# === Phase 2: Config ===`

Add the following code block:

```python
    # === Moonraker Safety Check ===
    from moonraker import get_print_status, get_mcu_versions, get_host_klipper_version, is_mcu_outdated

    print_status = get_print_status()

    if print_status is None:
        # Moonraker unreachable - warn and require confirmation
        out.warn("Moonraker unreachable - print status and version check unavailable")
        if not out.confirm("Continue without safety checks?", default=False):
            out.phase("Flash", "Cancelled")
            return 0
    elif print_status.state in ("printing", "paused"):
        # Block flash during active print
        progress_pct = int(print_status.progress * 100)
        filename = print_status.filename or "unknown"
        out.error_with_recovery(
            "Printer busy",
            f"Print in progress: {filename} ({progress_pct}%)",
            recovery=(
                "1. Wait for current print to complete\n"
                "2. Or cancel print in Fluidd/Mainsail dashboard\n"
                "3. Then re-run flash command"
            ),
        )
        return 1
    else:
        # Safe state - show status and continue
        out.phase("Safety", f"Printer state: {print_status.state} - OK to flash")
```

This implements:
- SAFE-01: Query Moonraker for print status
- SAFE-02: Block if printing or paused
- SAFE-03: Show filename and progress percentage
- SAFE-04: Allow if idle, complete, cancelled, error, standby
- SAFE-05: Warn and prompt if Moonraker unreachable
  </action>
  <verify>
Verify code compiles: python -m py_compile kalico-flash/flash.py
Grep for safety check: grep -n "Moonraker Safety Check" kalico-flash/flash.py
Grep for print_status check: grep -n "print_status.state" kalico-flash/flash.py
  </verify>
  <done>
Print safety check added to cmd_flash() that blocks during printing/paused states and prompts for confirmation when Moonraker unreachable.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add version display to cmd_flash()</name>
  <files>kalico-flash/flash.py</files>
  <action>
Add version display code after the safety check, before Phase 2 Config. This is informational only - never blocks flash.

Add after the safety check block:

```python
    # === Version Information ===
    host_version = get_host_klipper_version(data.global_config.klipper_dir)
    mcu_versions = get_mcu_versions()

    if host_version:
        out.phase("Version", f"Host Klipper: {host_version}")

        if mcu_versions:
            # Display all MCU versions, mark target with asterisk
            # Map device MCU type to Moonraker MCU name by checking mcu_constants
            target_mcu = None
            for mcu_name in mcu_versions:
                # Simple heuristic: if device mcu contains the mcu_name or vice versa
                if entry.mcu.lower() in mcu_name.lower() or mcu_name.lower() in entry.mcu.lower():
                    target_mcu = mcu_name
                    break
            # If no match found by name, use "main" as default for primary MCU
            if target_mcu is None and "main" in mcu_versions:
                target_mcu = "main"

            for mcu_name, mcu_version in sorted(mcu_versions.items()):
                marker = "*" if mcu_name == target_mcu else " "
                out.phase("Version", f"  [{marker}] MCU {mcu_name}: {mcu_version}")

            # Check if target MCU is outdated
            if target_mcu and target_mcu in mcu_versions:
                if is_mcu_outdated(host_version, mcu_versions[target_mcu]):
                    out.warn("MCU firmware is behind host Klipper - update recommended")
        else:
            out.warn("MCU versions unavailable (Klipper may not be running)")
    elif mcu_versions:
        # Have MCU versions but not host version (unusual)
        out.warn("Host Klipper version unavailable")
    # If neither available, skip version display silently (Moonraker down case handled above)
```

This implements:
- VER-01: Show host Klipper version from git describe
- VER-02: Show MCU firmware versions from Moonraker
- VER-03: Indicate if update needed (version mismatch warning)
- VER-05: Gracefully handle unreachable Moonraker (skip check)
- VER-06: Gracefully handle unresponsive MCU (skip check)
- VER-07: Works with multiple MCUs (shows all, marks target)

Note: VER-04 (default prompt answer) is not applicable here as version check is informational only - does not prompt.
  </action>
  <verify>
Verify code compiles: python -m py_compile kalico-flash/flash.py
Grep for version display: grep -n "Version Information" kalico-flash/flash.py
Grep for host version: grep -n "Host Klipper" kalico-flash/flash.py
Grep for MCU outdated check: grep -n "is_mcu_outdated" kalico-flash/flash.py
  </verify>
  <done>
Version display added showing host Klipper and MCU firmware versions with mismatch indication.
  </done>
</task>

</tasks>

<verification>
1. errors.py has updated printer_busy template without --force mention
2. flash.py imports from moonraker module
3. Print status check blocks on "printing" and "paused" states
4. Print status check allows "standby", "complete", "cancelled", "error"
5. Moonraker unreachable shows warning and Y/N confirmation prompt
6. Version display shows host and MCU versions in phase output
7. Target MCU marked with asterisk in version list
8. Version mismatch shows warning but does not block
9. All Python files compile: python -m py_compile kalico-flash/*.py
</verification>

<success_criteria>
- Print safety check blocks flash during active prints with filename and progress
- Moonraker unavailable shows warning and requires user confirmation to proceed
- Version table displays before flash with host and all MCU versions
- Target MCU highlighted in version table
- Version mismatch shows recommendation but never blocks
- All requirements SAFE-01 through SAFE-05, VER-01 through VER-07 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/05-moonraker-integration/05-02-SUMMARY.md`
</output>
