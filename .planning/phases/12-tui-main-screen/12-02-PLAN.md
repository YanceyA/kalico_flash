---
phase: 12-tui-main-screen
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - kflash/tui.py
  - kflash/flash.py
autonomous: true

must_haves:
  truths:
    - "Main menu displays panel-based screen with Status, Devices, and Actions panels instead of old box-drawn menu"
    - "Single keypress selects an action (F, A, R, D, C, B, Q) without pressing Enter"
    - "Device-targeting actions (Flash, Remove) prompt for device number after action key"
    - "Screen refreshes after every command completes, returning user to full panel menu with updated status"
    - "Refresh Devices action re-scans USB and updates device panel (replaces old List Devices)"
    - "Devices are numbered and numbers persist across action selection"
  artifacts:
    - path: "kflash/tui.py"
      provides: "Panel-based interactive TUI loop with single keypress input"
      min_lines: 200
    - path: "kflash/flash.py"
      provides: "Updated cmd routing (no changes to cmd_* functions themselves)"
  key_links:
    - from: "kflash/tui.py"
      to: "kflash/screen.py"
      via: "render_main_screen, build_device_list, ScreenState imports"
      pattern: "from.*screen.*import"
    - from: "kflash/tui.py"
      to: "kflash/panels.py"
      via: "center_panel for output centering"
      pattern: "from.*panels.*import"
    - from: "kflash/tui.py"
      to: "kflash/flash.py"
      via: "cmd_flash, cmd_add_device, cmd_remove_device dispatch"
      pattern: "from.*flash.*import"
---

<objective>
Wire the panel-based main screen into the interactive TUI loop. Replace the old numbered menu with panel rendering, single-keypress action selection, device number prompting for targeted actions, and post-command screen refresh.

Purpose: This connects the rendering layer (Plan 01) to the interactive loop, completing the panel-based main screen that users see when running `kflash` without arguments.

Output: Updated `kflash/tui.py` with panel-based run_menu, updated action dispatch. Minor updates to `kflash/flash.py` if needed for return values.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-tui-main-screen/12-CONTEXT.md
@.planning/phases/12-tui-main-screen/12-RESEARCH.md
@.planning/phases/12-tui-main-screen/12-01-SUMMARY.md
@kflash/tui.py
@kflash/screen.py
@kflash/flash.py
@kflash/theme.py
@kflash/panels.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite tui.py with panel-based loop and single keypress input</name>
  <files>kflash/tui.py</files>
  <action>
Rewrite `kflash/tui.py` to replace the old numbered menu with the panel-based main screen. Keep the settings submenu, wait_for_device, and _get_menu_choice functions (they're still used elsewhere).

**New/modified components:**

1. `_getch() -> str`: Cross-platform single keypress reader.
   - Windows: `import msvcrt; return msvcrt.getwch()`
   - Unix: Use termios to set raw mode, read one char, restore. Wrap in try/finally.
   - Return lowercase character.

2. `_build_screen_state(registry, out, status_message, status_level) -> ScreenState`:
   - Loads registry data, scans USB devices, fetches MCU versions and host version
   - Calls build_device_list() and constructs ScreenState
   - Late imports for discovery, moonraker modules

3. Updated `run_menu(registry, out) -> int`:
   - Non-TTY guard (keep existing)
   - Initialize: status_message = welcome, status_level = "info", device_map = {}
   - Main loop:
     a. Build screen state via _build_screen_state()
     b. Store device_map: {number -> DeviceRow} for device-targeting actions
     c. Clear screen, print render_main_screen(state)
     d. Print prompt line: "  Press action key: " (styled with theme.prompt)
     e. Read single keypress via _getch()
     f. Dispatch based on key:
        - "f" -> _action_flash_device (prompt for device number from device_map)
        - "a" -> _action_add_device
        - "r" -> _action_remove_device (prompt for device number)
        - "d" -> _action_refresh (just continue loop — screen rebuilds on next iteration)
        - "c" -> _settings_menu (existing, unchanged)
        - "b" -> _action_flash_all (placeholder: set status to "Flash All not yet implemented")
        - "q" -> return 0
        - Ctrl+C (KeyboardInterrupt) -> return 0
        - Other -> set status_message = "Unknown key '{key}'. Use F/A/R/D/C/B/Q.", status_level = "warning"
     g. After action completes, update status_message and status_level based on result
     h. Loop back to (a) — screen refreshes automatically

4. `_prompt_device_number(device_map, out) -> str | None`:
   - Print prompt: "  Device #: " (on the same line after action key)
   - Use input() (Enter-confirmed) to read device number
   - Validate: must be a key in device_map
   - Return device key (string) or None if invalid/cancelled
   - Max 3 attempts

5. Updated action handlers:
   - `_action_flash_device(registry, out, device_key) -> tuple[str, str]`:
     Returns (status_message, status_level) instead of None.
     Calls cmd_flash with the device_key. Returns success/error message.
   - `_action_add_device(registry, out) -> tuple[str, str]`:
     Returns (message, level). Calls cmd_add_device.
   - `_action_remove_device(registry, out, device_key) -> tuple[str, str]`:
     Returns (message, level). Calls cmd_remove_device.

6. Keep existing components unchanged:
   - `_get_menu_choice()` — still used by cmd_flash interactive selection and cmd_add_device
   - `wait_for_device()` — still used by flash workflow
   - `_settings_menu()` and its helpers — keep as-is for now (Phase 13 will redesign)
   - `UNICODE_BOX`, `ASCII_BOX`, `_supports_unicode`, `_get_box_chars` — keep for settings menu backward compat

**Important notes:**
- The old MENU_OPTIONS and _render_menu are no longer used by run_menu but keep _render_menu for _settings_menu
- Device numbers from screen.py DeviceRow.number map to device keys — store this mapping in run_menu loop
- After _settings_menu returns, just continue the loop (screen refreshes)
- For Flash and Remove actions: after pressing F or R, the prompt for device number appears below the panels. If only 1 actionable device, auto-select it.
- Status messages from actions should be concise: "Flash Device: {name} flashed successfully" or "Flash Device: failed — {brief reason}"
  </action>
  <verify>
  1. Sync to Pi: `scp kflash/tui.py kflash/screen.py yanceya@192.168.50.50:~/kalico-flash/kflash/`
  2. Run on Pi: `ssh yanceya@192.168.50.50 "cd ~/kalico-flash && python3 -c \"from kflash.tui import run_menu; print('import ok')\""`
  3. Test interactively: `ssh -t yanceya@192.168.50.50 "cd ~/kalico-flash && python3 flash.py"` — verify panel screen appears, Q quits, D refreshes, unknown keys show warning status.
  </verify>
  <done>
  run_menu displays panel-based screen with three panels. Single keypress selects actions. Device-targeting actions prompt for device number. Screen refreshes after every command. Q exits cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify full interactive flow on Pi</name>
  <files>kflash/tui.py, kflash/screen.py</files>
  <action>
  Sync all modified files to Pi and run the full interactive flow:

  1. `scp kflash/*.py yanceya@192.168.50.50:~/kalico-flash/kflash/`
  2. SSH with TTY: `ssh -t yanceya@192.168.50.50 "cd ~/kalico-flash && python3 flash.py"`
  3. Verify:
     - Three panels render with rounded borders
     - Connected devices show green dot, disconnected show grey dot
     - Press D — screen refreshes with updated device scan
     - Press invalid key — status panel shows warning
     - Press Q — exits cleanly
     - Press F — prompts for device number (if devices exist)
     - Press A — launches add device wizard, returns to panel screen after
     - Press C — opens settings submenu, returns to panel screen after

  If any issues, fix in tui.py or screen.py.

  Also verify backward compatibility:
  - `python3 flash.py --list-devices` still works (uses cmd_list_devices, not panel screen)
  - `python3 flash.py --device octopus-pro` still works (uses cmd_flash directly)
  - `python3 flash.py --help` still works
  </action>
  <verify>
  All 3 verification flows above pass on Pi hardware. Panel screen renders correctly with live device data. CLI commands still work unchanged.
  </verify>
  <done>
  Panel-based main screen works on live Pi hardware with real devices. All existing CLI commands maintain backward compatibility. Screen refresh works after every action.
  </done>
</task>

</tasks>

<verification>
1. `python3 flash.py` on Pi shows three-panel main screen (not old numbered menu)
2. Single keypress F/A/R/D/C/B/Q dispatches correct actions
3. Device numbers from panel are usable for Flash and Remove device selection
4. Screen refreshes after every command completes
5. `python3 flash.py --list-devices` and `python3 flash.py --help` still work
6. Ctrl+C at main screen exits with code 0
</verification>

<success_criteria>
The interactive TUI shows a panel-based main screen with Status, Devices, and Actions panels. Users can navigate all actions via single keypress, select devices by number, and the screen refreshes after every operation. All existing CLI commands continue to work.
</success_criteria>

<output>
After completion, create `.planning/phases/12-tui-main-screen/12-02-SUMMARY.md`
</output>
