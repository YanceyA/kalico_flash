---
phase: 12-tui-main-screen
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - kflash/screen.py
autonomous: true

must_haves:
  truths:
    - "build_device_list() returns devices grouped by status (registered connected, registered disconnected, new, blocked) with numbered references"
    - "build_status_content() returns welcome message on first launch, last command result after actions"
    - "render_main_screen() produces three panels (Status, Devices, Actions) as a single printable string"
    - "Device rows show name, truncated serial path, version, and status icon (green/grey dot)"
    - "Actions panel shows two-column layout with key letters: Flash Device, Add Device, Remove Device, Refresh Devices, Config, Flash All, Quit"
    - "Host Klipper version appears in device panel footer"
  artifacts:
    - path: "kflash/screen.py"
      provides: "Main screen data aggregation and rendering"
      min_lines: 150
  key_links:
    - from: "kflash/screen.py"
      to: "kflash/panels.py"
      via: "render_panel, render_two_column, center_panel imports"
      pattern: "from.*panels.*import"
    - from: "kflash/screen.py"
      to: "kflash/theme.py"
      via: "get_theme for color styling"
      pattern: "from.*theme.*import"
---

<objective>
Create the main screen module that aggregates device data and renders three panel-based sections (Status, Devices, Actions) using Phase 11 panel primitives.

Purpose: This is the rendering and data layer for the new TUI main screen. It produces a complete screen string that the interactive loop (Plan 02) will print after clearing the terminal.

Output: `kflash/screen.py` with pure functions for device aggregation, status tracking, and full-screen rendering.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-tui-main-screen/12-CONTEXT.md
@.planning/phases/12-tui-main-screen/12-RESEARCH.md
@.planning/phases/11-panel-renderer/11-01-SUMMARY.md
@kflash/panels.py
@kflash/theme.py
@kflash/models.py
@kflash/flash.py (for _build_blocked_list, _blocked_reason_for_entry, _blocked_reason_for_filename patterns)
@kflash/discovery.py (for scan_serial_devices, match_devices, is_supported_device)
@kflash/moonraker.py (for get_mcu_versions, get_host_klipper_version, get_mcu_version_for_device)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create screen.py with device aggregation and screen rendering</name>
  <files>kflash/screen.py</files>
  <action>
Create `kflash/screen.py` with the following components:

**Data structures:**

1. `DeviceRow` dataclass: `number: int, key: str, name: str, mcu: str, serial_path: str, version: str | None, connected: bool, group: str` where group is one of "registered", "new", "blocked". Number is 0 for non-actionable items (blocked).

2. `ScreenState` dataclass: `devices: list[DeviceRow], host_version: str | None, status_message: str, status_level: str` where status_level is "info", "success", "error", "warning".

**Pure functions:**

3. `build_device_list(registry_data, usb_devices, blocked_list, mcu_versions) -> list[DeviceRow]`:
   - Cross-reference registry against USB scan (reuse patterns from flash.py cmd_list_devices)
   - Group into: registered connected (numbered #1, #2...), registered disconnected (numbered, after connected), new devices (numbered, after registered), blocked (number=0)
   - For each device, look up MCU version via get_mcu_version_for_device
   - Truncate serial path: if display_width > 40 chars, keep first 18 + "..." + last 18

4. `truncate_serial(path: str, max_width: int = 40) -> str`:
   - If path fits, return as-is
   - Otherwise: first 18 chars + "..." + last 18 chars (adjust for exact max_width)

5. `render_device_row(row: DeviceRow, theme) -> str`:
   - Status icon: connected = `theme.success + "●"`, disconnected = `theme.subtle + "○"`
   - Format: `{icon} #{number}  {name} ({mcu})  {truncated_serial}  {version}`
   - For blocked: `{icon} {name}  {reason}` (no number)
   - Use theme colors: name in theme.text, serial in theme.subtle, version in theme.value

6. `render_status_panel(status_message: str, status_level: str) -> str`:
   - Uses render_panel with header "status"
   - Color the message based on level: success=theme.success, error=theme.error, warning=theme.warning, info=theme.text
   - Default welcome: "Welcome to kalico-flash. Select an action below."

7. `render_devices_panel(devices: list[DeviceRow], host_version: str | None) -> str`:
   - Uses render_panel with header "devices"
   - Group devices by group field, add section labels inside panel: "Registered", "New", "Blocked" (only show groups that have items)
   - Section labels styled with theme.label
   - Add blank line between groups
   - Footer line at bottom: "Host Klipper: {version}" or "Host version: unavailable" styled in theme.subtle
   - Empty state: "No devices found. Connect a board and select Refresh."

8. `render_actions_panel() -> str`:
   - Uses render_panel with header "actions"
   - Items: `[("F", "Flash Device"), ("A", "Add Device"), ("R", "Remove Device"), ("D", "Refresh Devices"), ("C", "Config"), ("B", "Flash All"), ("Q", "Quit")]`
   - Use render_two_column from panels.py
   - Each item shows the key letter highlighted: use theme.label for the key letter, theme.text for rest of label

9. `render_main_screen(state: ScreenState) -> str`:
   - Renders all three panels top-to-bottom
   - Join with single blank line between panels
   - Center each panel using center_panel()
   - Return single string ready for print()

**Important implementation notes:**
- All imports from sibling modules use relative imports (from .panels import ...)
- Use display_width() from kflash.ansi for ANSI-safe width calculations
- Do NOT import or call scan_serial_devices directly — receive data as parameters for testability
- The actions list defines the valid action keys that Plan 02 will use for dispatch
- Flash All is included as a menu item even though Phase 14 hasn't been built yet

**Action key format in render_actions_panel:**
Format each action as: `theme.label + key_letter + theme.reset + rest_of_word`. For example, "Flash Device" with key "F" becomes `theme.label + "F" + theme.reset + theme.text + "lash Device" + theme.reset`. The key letter IS the first letter of the first word.
  </action>
  <verify>
  Run on Pi: `ssh yanceya@192.168.50.50 "cd ~/kalico-flash && python3 -c \"from kflash.screen import render_main_screen, ScreenState, build_device_list; print('imports ok')\""`

  Verify locally: `python -c "from kflash.screen import render_main_screen, ScreenState, build_device_list, render_status_panel, render_devices_panel, render_actions_panel, DeviceRow, truncate_serial; print('All exports available')"` from kflash directory.
  </verify>
  <done>
  screen.py exists with all 9 components listed above. All public functions import without error. render_main_screen produces a multi-line string containing Status, Devices, and Actions panels with rounded Unicode borders.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify screen rendering with mock data</name>
  <files>kflash/screen.py</files>
  <action>
Write a temporary verification script (do NOT commit it — just run it) that:

1. Creates a ScreenState with mock data:
   - 2 connected registered devices, 1 disconnected, 1 new, 1 blocked
   - host_version = "v0.12.0-xxx-gdeadbeef"
   - status_message = welcome default

2. Calls render_main_screen(state) and prints the output

3. Verify visually:
   - Three panels visible with rounded corners (╭╮╰╯)
   - Device numbers sequential (#1 through #4, blocked has no number)
   - Status icons: green ● for connected, grey ○ for disconnected
   - Actions in two columns
   - Host version in device panel footer

4. Test truncate_serial with a long path (>40 chars) and short path (<40 chars)

5. Test render_actions_panel standalone — verify 7 actions in two-column layout

If any rendering issues found, fix them in screen.py before marking complete.
  </action>
  <verify>
  Run the verification script locally or on Pi. Visual inspection confirms three bordered panels render correctly with device grouping, numbering, status icons, and two-column actions.
  </verify>
  <done>
  render_main_screen produces correctly formatted output with all three panels. Device rows show icons, numbers, names, serial paths, and versions. Actions panel shows two-column layout with 7 items. Truncation works for long serial paths.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from kflash.screen import render_main_screen, ScreenState, DeviceRow"` succeeds
2. render_main_screen output contains `╭[ S T A T U S ]`, `╭[ D E V I C E S ]`, `╭[ A C T I O N S ]`
3. Device numbering is sequential across groups
4. Actions panel contains all 7 items: Flash Device, Add Device, Remove Device, Refresh Devices, Config, Flash All, Quit
</verification>

<success_criteria>
screen.py is a complete rendering module that produces the full main screen layout. All three panels render with correct borders, content, and styling. The module is ready to be wired into the interactive TUI loop.
</success_criteria>

<output>
After completion, create `.planning/phases/12-tui-main-screen/12-01-SUMMARY.md`
</output>
