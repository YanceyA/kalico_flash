---
phase: 28-flash-all-preflight
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - kflash/flash.py
autonomous: true

must_haves:
  truths:
    - "Flash All aborts before any device processing if Klipper dir, Makefile, make, or Katapult flashtool are missing"
    - "Flash All prompts for confirmation when Moonraker is unreachable, matching single-device cmd_flash() behavior"
    - "Flash All skips a device when its resolved USB path was already used by a prior device in the batch"
  artifacts:
    - path: "kflash/flash.py"
      provides: "Preflight checks, Moonraker prompt, and duplicate path guard in cmd_flash_all()"
      contains: "_preflight_flash"
  key_links:
    - from: "cmd_flash_all()"
      to: "_preflight_flash()"
      via: "call before batch loop"
      pattern: "_preflight_flash\\(out"
    - from: "cmd_flash_all()"
      to: "get_print_status()"
      via: "Moonraker check before batch loop"
      pattern: "get_print_status\\(\\)"
    - from: "cmd_flash_all() flash loop"
      to: "used_paths set"
      via: "realpath duplicate check"
      pattern: "os\\.path\\.realpath"
---

<objective>
Add three preflight safety mechanisms to cmd_flash_all() in flash.py: environment validation via _preflight_flash(), Moonraker unreachable confirmation prompt, and duplicate USB path detection.

Purpose: Flash All currently lacks the safety checks that single-device flash has, and has no protection against two registry entries targeting the same physical device.
Output: Modified flash.py with all three checks integrated into cmd_flash_all().
</objective>

<context>
@.planning/phases/28-flash-all-preflight/28-RESEARCH.md

Key code locations in kflash/flash.py:
- cmd_flash_all(): lines 958-1297 (the function being modified)
- _preflight_flash(): lines 114-157 (reuse for SAFE-01)
- cmd_flash() preflight: lines 636-640 (pattern to replicate)
- cmd_flash() moonraker check: lines 648-673 (pattern to replicate)
- Stage 4 print check: ~line 1192 (to be removed after moving to top)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add preflight and Moonraker check before batch loop</name>
  <files>kflash/flash.py</files>
  <action>
In cmd_flash_all(), after loading global_config (around line 1008, after katapult_dir assignment) and BEFORE Stage 1, insert two blocks:

**Block 1 - Environment preflight (SAFE-01):**
```python
preferred_method = (global_config.default_flash_method or "katapult").strip().lower()
allow_fallback = global_config.allow_flash_fallback
if not _preflight_flash(out, klipper_dir, katapult_dir, preferred_method, allow_fallback):
    return 1
```

**Block 2 - Moonraker check (SAFE-02):**
Replicate the pattern from cmd_flash() lines 648-673:
```python
print_status = get_print_status()
if print_status is None:
    out.warn("Moonraker unreachable - print status and version check unavailable")
    if not out.confirm("Continue without safety checks?", default=False):
        out.phase("Flash All", "Cancelled")
        return 0
elif print_status.state in ("printing", "paused"):
    progress_pct = int(print_status.progress * 100)
    filename = print_status.filename or "unknown"
    out.error(f"Print in progress: {filename} ({progress_pct}%). Aborting flash.")
    return 1
else:
    out.phase("Safety", f"Printer state: {print_status.state} - OK to flash")
```

Then REMOVE the existing Stage 4 print status check (~line 1192-1196) that duplicates this logic. Look for the print_status check inside the flash loop (Stage 4) and remove it, since it now runs before any builds.
  </action>
  <verify>
Grep for `_preflight_flash` in cmd_flash_all -- should appear once.
Grep for `get_print_status` in cmd_flash_all -- should appear once (at top, not in Stage 4).
Grep for `"printing", "paused"` -- should appear in both cmd_flash and cmd_flash_all.
  </verify>
  <done>
cmd_flash_all() calls _preflight_flash() once before the batch loop and prompts on Moonraker unreachable, matching cmd_flash() behavior. No duplicate print check in Stage 4.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add duplicate USB path tracking in flash loop</name>
  <files>kflash/flash.py</files>
  <action>
In cmd_flash_all(), add duplicate USB path detection (SAFE-04):

1. Before the flash loop (Stage 4), initialize: `used_paths: set[str] = set()`

2. Inside the flash loop, after match_device() resolves usb_device but BEFORE calling flash_device(), add:
```python
if usb_device is not None:
    real_path = os.path.realpath(usb_device.path)
    if real_path in used_paths:
        result.error_message = "USB path already targeted by prior device"
        result.skipped = True
        out.warn(f"Skipping {entry.name}: duplicate USB path")
        continue
    used_paths.add(real_path)
```

Ensure `os` is already imported (it should be). The `result` variable refers to the BatchDeviceResult for this device in the loop. Check the existing loop structure to place this correctly -- it must be after the device match but before the flash attempt.

If BatchDeviceResult doesn't have a `skipped` field, set `result.error_message` only and use `continue` to skip to next device.
  </action>
  <verify>
Grep for `used_paths` in flash.py -- should appear (set init + check + add).
Grep for `os.path.realpath` in flash.py -- should appear in the flash loop.
  </verify>
  <done>
Flash loop tracks resolved USB paths and skips devices whose path was already used by a prior device in the batch, with a warning message.
  </done>
</task>

</tasks>

<verification>
1. `_preflight_flash` is called in cmd_flash_all() before the batch loop
2. `get_print_status()` is called once in cmd_flash_all() before Stage 1, not in Stage 4
3. `used_paths` set is initialized before the flash loop and checked inside it
4. `os.path.realpath` is used for path comparison
5. No duplicate print status check remains in Stage 4
6. Python syntax check: `python -c "import ast; ast.parse(open('kflash/flash.py').read())"` passes
</verification>

<success_criteria>
- cmd_flash_all() fails fast on missing environment prerequisites
- cmd_flash_all() prompts user when Moonraker is unreachable
- cmd_flash_all() skips devices with duplicate resolved USB paths
- No regressions in existing flash.py functionality
</success_criteria>

<output>
After completion, create `.planning/phases/28-flash-all-preflight/28-01-SUMMARY.md`
</output>
