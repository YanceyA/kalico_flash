---
phase: 06-user-experience
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - kalico-flash/tui.py
  - kalico-flash/registry.py
autonomous: true

must_haves:
  truths:
    - "User selecting Add device completes wizard and returns to menu"
    - "User selecting List devices sees device list and returns to menu"
    - "User selecting Flash completes flash and returns to menu"
    - "User selecting Remove device confirms and returns to menu"
    - "User selecting Settings sees submenu with path options"
    - "User entering invalid input gets error and can retry (max 3 times)"
  artifacts:
    - path: "kalico-flash/tui.py"
      provides: "Full menu handlers and settings submenu"
      contains: "_settings_menu"
      min_lines: 150
  key_links:
    - from: "kalico-flash/tui.py"
      to: "kalico-flash/flash.py"
      via: "cmd_* function imports"
      pattern: "from flash import cmd_"
    - from: "kalico-flash/tui.py"
      to: "kalico-flash/registry.py"
      via: "Registry class for settings"
      pattern: "registry\\.save_global"
---

<objective>
Implement menu action handlers and settings submenu in tui.py.

Purpose: Users can complete any action (Add, List, Flash, Remove, Settings) and return to menu without program exit.

Output: tui.py with working handlers calling existing cmd_* functions, Settings submenu for path editing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-user-experience/06-CONTEXT.md
@.planning/phases/06-user-experience/06-01-SUMMARY.md
@kalico-flash/tui.py
@kalico-flash/flash.py
@kalico-flash/registry.py
@kalico-flash/output.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement menu action handlers</name>
  <files>kalico-flash/tui.py</files>
  <action>
Replace stub handlers in tui.py with actual implementations:

1. **Add device handler:**
   ```python
   def _handle_add_device(registry, out) -> None:
       from flash import cmd_add_device
       cmd_add_device(registry, out)
       # Return value ignored - always return to menu
   ```

2. **List devices handler:**
   ```python
   def _handle_list_devices(registry, out) -> None:
       from flash import cmd_list_devices
       cmd_list_devices(registry, out)
   ```

3. **Flash device handler:**
   ```python
   def _handle_flash(registry, out) -> None:
       from flash import cmd_flash
       # Pass device_key=None for interactive selection within cmd_flash
       cmd_flash(registry, None, out, skip_menuconfig=False)
   ```

4. **Remove device handler:**
   - Prompt for device key (use out.prompt)
   - Call `from flash import cmd_remove_device; cmd_remove_device(registry, key, out)`
   - Or: Show numbered list of devices first, let user pick (better UX)

5. **Update handlers dict in run_menu():**
   ```python
   handlers = {
       "1": ("Add device", lambda: _handle_add_device(registry, out)),
       "2": ("List devices", lambda: _handle_list_devices(registry, out)),
       "3": ("Flash device", lambda: _handle_flash(registry, out)),
       "4": ("Remove device", lambda: _handle_remove_device(registry, out)),
       "5": ("Settings", lambda: _settings_menu(registry, out)),
       "0": ("Exit", None),
   }
   ```

6. **Handle action errors gracefully:** Wrap handler calls in try/except, catch KlipperFlashError and show error via out.error(), then continue menu loop.

Per CONTEXT.md: "Return to menu silently after actions - show success message, then menu reappears immediately (no 'Press Enter')".
  </action>
  <verify>
Syntax check: `python -m py_compile kalico-flash/tui.py`
Import test: `python -c "from tui import run_menu; print('handlers OK')"`
  </verify>
  <done>All 5 menu options (Add, List, Flash, Remove, Settings) dispatch to working handlers</done>
</task>

<task type="auto">
  <name>Task 2: Implement Settings submenu</name>
  <files>kalico-flash/tui.py</files>
  <action>
Add Settings submenu per TUI-07: "Settings submenu: Change Klipper dir, Change Katapult dir, View settings"

1. **Create _settings_menu() function:**
   ```python
   def _settings_menu(registry, out) -> None:
       """Settings submenu for path configuration."""
       box = get_box_chars()

       while True:
           # Load current settings
           data = registry.load()
           gc = data.global_config

           # Render settings submenu
           options = [
               ("1", "Change Klipper directory"),
               ("2", "Change Katapult directory"),
               ("3", "View current settings"),
               ("0", "Back to main menu"),
           ]
           print(_render_menu(options, box))

           choice = input("Select option: ").strip()

           if choice == "0":
               return  # Back to main menu

           elif choice == "1":
               current = gc.klipper_dir if gc else "~/klipper"
               new_path = out.prompt("Klipper source directory", default=current)
               _update_klipper_dir(registry, new_path, out)

           elif choice == "2":
               current = gc.katapult_dir if gc else "~/katapult"
               new_path = out.prompt("Katapult source directory", default=current)
               _update_katapult_dir(registry, new_path, out)

           elif choice == "3":
               _view_settings(registry, out)

           else:
               out.warn(f"Invalid option: {choice}")
   ```

2. **Helper functions:**
   ```python
   def _update_klipper_dir(registry, new_path: str, out) -> None:
       data = registry.load()
       if data.global_config:
           from models import GlobalConfig
           new_gc = GlobalConfig(
               klipper_dir=new_path,
               katapult_dir=data.global_config.katapult_dir,
               default_flash_method=data.global_config.default_flash_method,
           )
           registry.save_global(new_gc)
           out.success(f"Klipper directory updated to: {new_path}")
       else:
           out.warn("No global config exists. Run Add device first.")

   def _view_settings(registry, out) -> None:
       data = registry.load()
       gc = data.global_config
       if gc:
           out.info("Settings", f"Klipper directory: {gc.klipper_dir}")
           out.info("Settings", f"Katapult directory: {gc.katapult_dir}")
           out.info("Settings", f"Default flash method: {gc.default_flash_method}")
       else:
           out.info("Settings", "No global configuration set. Run Add device first.")
   ```

3. **Same box drawing as main menu** - reuse get_box_chars() and _render_menu().
  </action>
  <verify>
Syntax check: `python -m py_compile kalico-flash/tui.py`
Manual: Run menu, select Settings (5), verify submenu appears with 4 options
  </verify>
  <done>Settings submenu shows 3 actions (change Klipper dir, change Katapult dir, view settings) plus back option</done>
</task>

<task type="auto">
  <name>Task 3: Add invalid input handling with retry logic</name>
  <files>kalico-flash/tui.py</files>
  <action>
Per TUI-04: "Invalid input shows error and re-prompts (max 3 attempts)"

1. **Create input helper function:**
   ```python
   def _get_menu_choice(valid_choices: list[str], out, max_attempts: int = 3) -> str | None:
       """Get valid menu choice with retry logic.

       Args:
           valid_choices: List of valid input strings (e.g., ["0", "1", "2", "3", "4", "5", "q"])
           out: Output interface for warnings
           max_attempts: Maximum attempts before returning None

       Returns:
           Valid choice string, or None if max attempts exceeded
       """
       for attempt in range(max_attempts):
           choice = input("Select option: ").strip().lower()

           # Normalize q/Q to "0" for exit
           if choice in ("q", "Q"):
               return "0"

           if choice in valid_choices:
               return choice

           remaining = max_attempts - attempt - 1
           if remaining > 0:
               out.warn(f"Invalid option '{choice}'. {remaining} attempts remaining.")
           else:
               out.warn(f"Invalid option '{choice}'. Too many invalid attempts.")

       return None  # Max attempts exceeded
   ```

2. **Update run_menu() to use _get_menu_choice():**
   ```python
   while True:
       print(_render_menu(options, box))
       choice = _get_menu_choice(["0", "1", "2", "3", "4", "5"], out)

       if choice is None:
           out.error("Too many invalid inputs. Exiting.")
           return 1

       if choice == "0":
           return 0

       if choice in handlers and handlers[choice][1] is not None:
           try:
               handlers[choice][1]()
           except KeyboardInterrupt:
               out.warn("Cancelled")
           except Exception as e:
               out.error(f"Action failed: {e}")
   ```

3. **Apply same pattern to Settings submenu** - use _get_menu_choice() there too.

Per CONTEXT.md: After 3 invalid attempts, exit the menu (not crash). Return code 1 signals abnormal exit.
  </action>
  <verify>
Syntax check: `python -m py_compile kalico-flash/tui.py`
Manual test: Enter invalid option 3 times, verify graceful exit with error message
  </verify>
  <done>Invalid input shows error with remaining attempts, exits after 3 failures</done>
</task>

</tasks>

<verification>
1. `python -m py_compile kalico-flash/tui.py` - no syntax errors
2. Menu option 1 (Add) -> runs add device wizard -> returns to menu
3. Menu option 2 (List) -> shows device list -> returns to menu
4. Menu option 3 (Flash) -> shows device selection -> returns to menu after completion
5. Menu option 4 (Remove) -> prompts for device -> returns to menu
6. Menu option 5 (Settings) -> shows settings submenu -> can return to main menu
7. Settings submenu can change Klipper dir, Katapult dir, view settings
8. Invalid input shows "X attempts remaining" and re-prompts
9. 3 invalid inputs exits with error message
</verification>

<success_criteria>
- All menu actions dispatch to existing cmd_* functions
- Actions complete and return to menu without exiting
- Settings submenu allows path configuration
- Invalid input handled with 3-attempt retry
- Requirements addressed: TUI-02, TUI-03, TUI-04, TUI-07
</success_criteria>

<output>
After completion, create `.planning/phases/06-user-experience/06-02-SUMMARY.md`
</output>
