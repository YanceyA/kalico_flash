---
phase: 06-user-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - kalico-flash/tui.py
  - kalico-flash/flash.py
autonomous: true

must_haves:
  truths:
    - "User running kflash with no args sees numbered menu"
    - "User can exit with 0, q, or Ctrl+C"
    - "User in non-TTY environment sees help, not broken menu"
    - "User on UTF-8 terminal sees Unicode box drawing"
    - "User on legacy terminal sees ASCII box drawing"
  artifacts:
    - path: "kalico-flash/tui.py"
      provides: "Menu loop, rendering, unicode detection"
      exports: ["run_menu"]
      min_lines: 100
    - path: "kalico-flash/flash.py"
      provides: "Entry point routing to TUI"
      contains: "from tui import run_menu"
  key_links:
    - from: "kalico-flash/flash.py"
      to: "kalico-flash/tui.py"
      via: "run_menu() import and call"
      pattern: "from tui import run_menu"
    - from: "kalico-flash/tui.py"
      to: "sys.stdin.isatty()"
      via: "TTY check before menu"
      pattern: "sys\\.stdin\\.isatty\\(\\)"
---

<objective>
Create tui.py module with menu loop and box rendering, wire into flash.py entry point.

Purpose: Provides the foundation for Phase 6 interactive menu system. Users get a numbered menu when running kflash without arguments.

Output: New tui.py module with run_menu() function, flash.py modified to route no-args to TUI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-user-experience/06-CONTEXT.md
@.planning/phases/06-user-experience/06-RESEARCH.md
@kalico-flash/flash.py
@kalico-flash/output.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tui.py with menu rendering and unicode detection</name>
  <files>kalico-flash/tui.py</files>
  <action>
Create new module `kalico-flash/tui.py` with:

1. **Unicode detection function:**
   ```python
   def _supports_unicode() -> bool:
       """Check if terminal supports Unicode box drawing."""
       lang = os.environ.get("LANG", "").upper()
       lc_all = os.environ.get("LC_ALL", "").upper()
       return "UTF-8" in lang or "UTF-8" in lc_all or "UTF8" in lang or "UTF8" in lc_all
   ```

2. **Box character constants:**
   - `UNICODE_BOX` dict with tl, tr, bl, br, h, v characters (U+250C, U+2510, U+2514, U+2518, U+2500, U+2502)
   - `ASCII_BOX` dict with +, -, | characters
   - `get_box_chars()` function returning appropriate dict

3. **Menu rendering function:**
   ```python
   def _render_menu(options: list[tuple[str, str]], box: dict) -> str:
       """Render numbered menu with box drawing. Returns multi-line string."""
   ```
   - Options list is (number, label) tuples
   - Per CONTEXT.md: Setup-first order: Add, List, Flash, Remove, Settings, Exit
   - Menu numbers: 1=Add, 2=List, 3=Flash, 4=Remove, 5=Settings, 0=Exit
   - Calculate width from max label length + padding
   - Build: top border, option lines, bottom border

4. **Main menu loop:**
   ```python
   def run_menu(registry, out) -> int:
       """Main interactive menu loop. Returns exit code."""
   ```
   - TTY check at start: if not sys.stdin.isatty(), print help message and return 0
   - Build handlers dict mapping choice -> (label, handler_func or None for exit)
   - While True loop: render menu, get input, dispatch to handler
   - Exit on "0", "q", or "Q" (return 0)
   - Catch KeyboardInterrupt in loop, return 0

Note: For this task, handlers will be stubs (just print "Not implemented yet" and return to menu). Actual implementations come in Plan 02.

Imports needed: os, sys (stdlib only per project constraints).
  </action>
  <verify>
Syntax check: `python -m py_compile kalico-flash/tui.py`
Import check: `python -c "from tui import run_menu; print('OK')"`
  </verify>
  <done>tui.py exists with run_menu(), _supports_unicode(), _render_menu(), get_box_chars(), and stub handlers</done>
</task>

<task type="auto">
  <name>Task 2: Wire tui.py into flash.py entry point</name>
  <files>kalico-flash/flash.py</files>
  <action>
Modify `kalico-flash/flash.py` main() function:

1. **Detect "no args" condition:** After argument parsing, check if no management commands AND no --device flag:
   ```python
   has_action = any([
       args.add_device,
       args.list_devices,
       args.remove_device,
       args.exclude_device,
       args.include_device,
       args.device,  # explicit --device flag
   ])
   ```

2. **Route to TUI or CLI:** If no action AND stdin is TTY:
   ```python
   if not has_action:
       if sys.stdin.isatty():
           from tui import run_menu
           return run_menu(registry, out)
       else:
           # Non-TTY with no args: show help per CONTEXT.md
           parser.print_help()
           return 0
   ```

3. **Remove existing interactive flash fallback:** The current code at line ~918 does `return cmd_flash(registry, args.device, out, ...)` when no management args. This becomes unreachable after our change (TUI handles no-args case). Keep the `args.device is not None` path for explicit --device.

4. **Update docstring/help text:** Ensure epilog mentions "Run without args for interactive menu".

The key insight: Currently, running with no args goes to cmd_flash() which has its own device selection. After this change, no args goes to TUI menu, and TUI menu's "Flash" option will call cmd_flash(None).
  </action>
  <verify>
Syntax check: `python -m py_compile kalico-flash/flash.py`
Help shows menu mention: `python flash.py --help`
  </verify>
  <done>flash.py routes no-args TTY to run_menu(), no-args non-TTY to help</done>
</task>

<task type="auto">
  <name>Task 3: Test menu rendering on target Pi</name>
  <files>N/A (verification only)</files>
  <action>
Verify menu functionality on target Raspberry Pi:

1. **Sync code to Pi:**
   ```bash
   scp kalico-flash/tui.py kalico-flash/flash.py yanceya@192.168.50.50:~/kalico-flash/
   ```

2. **Test Unicode detection:**
   ```bash
   ssh yanceya@192.168.50.50 "echo \$LANG"
   # Expected: en_US.UTF-8 or similar with UTF-8
   ```

3. **Test menu display:**
   ```bash
   ssh yanceya@192.168.50.50 "cd ~/kalico-flash && python3 flash.py"
   # Expected: Box-drawn menu with 6 options, Unicode characters if LANG=UTF-8
   ```

4. **Test exit paths:**
   - Enter "0" -> should exit cleanly with code 0
   - Enter "q" -> should exit cleanly with code 0
   - Press Ctrl+C -> should exit cleanly

5. **Test non-TTY fallback:**
   ```bash
   ssh yanceya@192.168.50.50 "echo '' | cd ~/kalico-flash && python3 flash.py"
   # Expected: Help text, not menu
   ```

6. **Test --device still works (regression):**
   ```bash
   ssh yanceya@192.168.50.50 "cd ~/kalico-flash && python3 flash.py --device nonexistent"
   # Expected: Error message about device not found, NOT menu
   ```
  </action>
  <verify>All manual tests pass as described</verify>
  <done>Menu displays correctly on Pi with Unicode, exits work, non-TTY shows help, --device still functions</done>
</task>

</tasks>

<verification>
1. `python -m py_compile kalico-flash/tui.py` - no syntax errors
2. `python -m py_compile kalico-flash/flash.py` - no syntax errors
3. Running `python flash.py` without args shows numbered menu (on TTY)
4. Menu has 6 options in setup-first order: Add, List, Flash, Remove, Settings, Exit
5. Entering 0 or q exits cleanly
6. Ctrl+C exits cleanly
7. Non-TTY input shows help text instead of menu
8. `python flash.py --device KEY` still works (doesn't show menu)
</verification>

<success_criteria>
- tui.py module created with run_menu() as only public API
- flash.py routes no-args to TUI on TTY, to help on non-TTY
- Menu renders with Unicode box drawing on UTF-8 terminals
- Menu renders with ASCII fallback on non-UTF-8 terminals
- Exit via 0, q, or Ctrl+C all work cleanly
- Requirements addressed: TUI-01, TUI-05, TUI-06, TUI-08 (partial)
</success_criteria>

<output>
After completion, create `.planning/phases/06-user-experience/06-01-SUMMARY.md`
</output>
