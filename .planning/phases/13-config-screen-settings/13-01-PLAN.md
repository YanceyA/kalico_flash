---
phase: 13-config-screen-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [kflash/models.py, kflash/registry.py, kflash/screen.py, kflash/tui.py]
autonomous: true

must_haves:
  truths:
    - "Config screen renders as a cleared screen with status panel and numbered settings rows showing current values"
    - "User can toggle skip-menuconfig, set stagger delay, set return delay, and edit directory paths; screen refreshes after each change"
    - "All settings persist in registry JSON global section and survive tool restart"
    - "Pressing C on main screen opens config screen; Esc or B returns to main screen"
  artifacts:
    - path: "kflash/models.py"
      provides: "GlobalConfig with 4 new fields: skip_menuconfig, stagger_delay, return_delay, config_cache_dir"
      contains: "skip_menuconfig"
    - path: "kflash/registry.py"
      provides: "Load/save for all new GlobalConfig fields"
      contains: "skip_menuconfig"
    - path: "kflash/screen.py"
      provides: "Config screen rendering function"
      contains: "config"
    - path: "kflash/tui.py"
      provides: "Config screen loop, C key in main menu actions"
      contains: "_config_screen"
  key_links:
    - from: "kflash/tui.py"
      to: "kflash/screen.py"
      via: "config screen render call"
      pattern: "render_config"
    - from: "kflash/tui.py"
      to: "kflash/registry.py"
      via: "save_global after setting change"
      pattern: "save_global"
---

<objective>
Add GlobalConfig fields for new settings, extend registry serialization, build config screen with panel rendering, and wire it into the main TUI loop.

Purpose: Users need a dedicated screen to view and change tool settings (skip menuconfig, delays, directories) with immediate persistence.
Output: Config screen accessible via C key from main menu, with 6 editable settings that persist in registry JSON.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-config-screen-settings/13-CONTEXT.md
@.planning/phases/13-config-screen-settings/13-RESEARCH.md
@kflash/models.py
@kflash/registry.py
@kflash/screen.py
@kflash/tui.py
@kflash/panels.py
@kflash/theme.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend GlobalConfig and registry serialization</name>
  <files>kflash/models.py, kflash/registry.py</files>
  <action>
Add 4 new fields to GlobalConfig dataclass in models.py:
- skip_menuconfig: bool = False
- stagger_delay: float = 2.0
- return_delay: float = 5.0
- config_cache_dir: str = "~/.config/kalico-flash/configs"

In registry.py, extend the load method to read these fields using .get() with defaults (backward compatible with old JSON files). Extend the save/serialization to write all new fields to the "global" section of devices.json.

Follow the exact patterns shown in 13-RESEARCH.md code examples for both load and save.
  </action>
  <verify>Read models.py to confirm 4 new fields with correct types and defaults. Read registry.py to confirm .get() calls for all new fields in load and serialization of all new fields in save.</verify>
  <done>GlobalConfig has all 4 new fields. Registry loads old JSON without error (defaults applied). Registry saves all new fields.</done>
</task>

<task type="auto">
  <name>Task 2: Build config screen rendering and interactive loop</name>
  <files>kflash/screen.py, kflash/tui.py</files>
  <action>
**screen.py:** Add a config screen render function (e.g., render_config_screen) that:
- Takes GlobalConfig (or registry data) as input
- Renders a status panel at top with instruction text ("Press setting number to edit, Esc to return")
- Renders a settings panel below with 6 numbered rows, each showing label and current value
- Settings list (use a module-level SETTINGS constant or similar):
  1. Skip menuconfig: ON/OFF (toggle)
  2. Stagger delay (seconds): value (numeric)
  3. Return delay (seconds): value (numeric)
  4. Klipper directory: path (path)
  5. Katapult directory: path (path)
  6. Config cache directory: path (path)
- Uses render_panel() from panels.py and center_panel() for centering
- Toggle values display as "ON"/"OFF", numeric as the number with "s" suffix, paths as-is

**tui.py:** Add a _config_screen function that:
- Clears screen, renders config screen, waits for keypress in a loop
- On Esc (\x1b) or "b"/"B": returns to main menu
- On digit 1-6: dispatches to appropriate edit handler
  - Toggle (setting 1): flip value immediately, save via registry, redraw
  - Numeric (settings 2-3): print prompt, use input() for value entry (cooked mode), validate as float > 0, save, redraw. On empty input or invalid, cancel edit.
  - Path (settings 4-6): print prompt, use input() for path entry, save, redraw. On empty input, cancel edit.
- After each successful edit, call registry save_global (or equivalent) to persist immediately
- Redraw the full config screen after each change

**Main menu wiring in tui.py:**
- Add "C" key to the actions panel (add a "Config" or "Settings" action with C key)
- In the main menu keypress dispatch, handle "c"/"C" to call _config_screen
- After _config_screen returns, redraw main screen (existing loop handles this)

Use _getch() for single keypress detection. For numeric/path input requiring typed text, switch to input() (cooked mode) — the existing pattern in _prompt_device_number shows how.
  </action>
  <verify>Run on Pi via SSH: python3 flash.py, press C to enter config screen, verify 6 settings display with current values. Toggle setting 1, change setting 2 to a different number, press Esc. Re-enter config to verify changes persisted. Check devices.json on disk for new fields.</verify>
  <done>Config screen renders with status panel and 6 numbered settings. All setting types (toggle, numeric, path) are editable. Changes persist in registry JSON immediately. C key opens config from main menu. Esc/B returns to main menu.</done>
</task>

</tasks>

<verification>
1. Start tool, press C — config screen shows status panel + settings panel with 6 rows
2. Press 1 — skip menuconfig toggles (OFF->ON), screen redraws with new value
3. Press 3 — prompted for return delay, enter "10", screen redraws showing 10s
4. Press Esc — returns to main menu
5. Restart tool, press C — settings show persisted values (skip=ON, return=10s)
6. Check devices.json — global section contains skip_menuconfig, stagger_delay, return_delay, config_cache_dir
</verification>

<success_criteria>
Config screen is fully functional with 6 editable settings. All changes persist across restarts. Main menu has C key for config access.
</success_criteria>

<output>
After completion, create `.planning/phases/13-config-screen-settings/13-01-SUMMARY.md`
</output>
