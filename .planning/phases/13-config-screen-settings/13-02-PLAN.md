---
phase: 13-config-screen-settings
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified: [kflash/tui.py]
autonomous: true

must_haves:
  truths:
    - "After flash/add-device/remove-device commands, a countdown displays before returning to menu"
    - "Any keypress during countdown skips it immediately"
    - "Countdown duration matches the return_delay setting from config"
    - "No countdown after refresh or config screen navigation"
  artifacts:
    - path: "kflash/tui.py"
      provides: "_wait_for_key and _countdown_return functions, countdown wired into action dispatch"
      contains: "_countdown_return"
  key_links:
    - from: "kflash/tui.py::_countdown_return"
      to: "kflash/tui.py::_wait_for_key"
      via: "polls for keypress each second"
      pattern: "_wait_for_key"
    - from: "kflash/tui.py action dispatch"
      to: "kflash/tui.py::_countdown_return"
      via: "called after flash/add/remove actions return"
      pattern: "_countdown_return"
---

<objective>
Implement cross-platform countdown timer with keypress cancellation and wire it into action dispatch for post-command return delay.

Purpose: After commands like flash or add-device, users see output briefly before the screen clears. A countdown gives them time to read results while allowing immediate skip.
Output: Countdown timer appears after applicable actions, respects return_delay setting, any key skips.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/13-config-screen-settings/13-CONTEXT.md
@.planning/phases/13-config-screen-settings/13-RESEARCH.md
@.planning/phases/13-config-screen-settings/13-01-SUMMARY.md
@kflash/tui.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement countdown timer with cross-platform keypress detection</name>
  <files>kflash/tui.py</files>
  <action>
Add two functions to tui.py:

**_wait_for_key(timeout: float) -> bool:**
Cross-platform non-blocking keypress detection with timeout.
- Windows: use msvcrt.kbhit() polling with time.sleep(0.05) intervals until timeout expires or key pressed. Consume key with msvcrt.getwch() if pressed.
- Unix: save terminal settings, set raw mode with tty.setraw(), use select.select() on stdin with timeout. Consume key with sys.stdin.read(1) if ready. Restore terminal settings in finally block.
- Returns True if key was pressed, False if timeout expired.
- Follow the exact pattern from 13-RESEARCH.md code example.

**_countdown_return(seconds: float) -> None:**
Display countdown, any keypress skips immediately.
- If seconds <= 0, return immediately (disabled).
- Loop from int(seconds) down to 1, each iteration:
  - Print themed line: "Returning to menu in Ns... (press any key)" using \r + flush for in-place update
  - Call _wait_for_key(timeout=1.0) — if returns True, break
- Print empty line to clear countdown text after loop ends.
- Use theme colors for the countdown text (subtle/dim style).

**Wire countdown into action dispatch:**
Find the main menu loop's action handlers for flash, add-device, remove-device (and flash-all when it exists). After each of these actions completes (before the loop redraws), call:
```python
_countdown_return(registry.load().global_config.return_delay)
```
Do NOT add countdown after: refresh, config screen, quit.
  </action>
  <verify>Run on Pi: python3 flash.py. Trigger an action that has countdown (e.g., add device or refresh-then-flash). After action completes, verify countdown appears and counts down. Press a key during countdown to verify it skips immediately. Change return_delay to 0 in config screen, verify no countdown appears.</verify>
  <done>Countdown timer displays after flash/add/remove actions. Keypress skips countdown. Duration respects return_delay setting. No countdown after refresh or config navigation. Works on both Unix (Pi) and Windows (dev).</done>
</task>

</tasks>

<verification>
1. Flash a device (or simulate) — countdown appears: "Returning to menu in 5s..."
2. Wait — countdown decrements each second
3. Press any key during countdown — immediately returns to menu
4. Go to config, set return delay to 0, repeat action — no countdown
5. Go to config, set return delay to 10, repeat action — countdown starts at 10
6. After refresh action — no countdown, returns immediately
</verification>

<success_criteria>
Countdown timer works cross-platform, respects return_delay setting, skippable by keypress, only appears after applicable actions.
</success_criteria>

<output>
After completion, create `.planning/phases/13-config-screen-settings/13-02-SUMMARY.md`
</output>
