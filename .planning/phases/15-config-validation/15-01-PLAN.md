---
phase: 15-config-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - kflash/validation.py
  - kflash/tui.py
autonomous: true

must_haves:
  truths:
    - "Invalid klipper_dir (non-existent or missing Makefile) is rejected with error and re-prompt"
    - "Invalid katapult_dir (non-existent or missing scripts/flashtool.py) is rejected with error and re-prompt"
    - "Invalid config_cache_dir (non-existent) is rejected with error and re-prompt"
    - "Tilde in paths is expanded before validation"
    - "stagger_delay outside 0-30 and return_delay outside 0-60 are rejected with error and re-prompt"
    - "Non-numeric input for numeric settings is rejected with error and re-prompt"
    - "Empty input cancels edit (no change saved)"
  artifacts:
    - path: "kflash/validation.py"
      provides: "Pure validation functions"
      exports: ["validate_path_setting", "validate_numeric_setting"]
    - path: "kflash/tui.py"
      provides: "Validation loops in settings edit flow"
  key_links:
    - from: "kflash/tui.py"
      to: "kflash/validation.py"
      via: "import and call in numeric/path edit branches"
      pattern: "from .validation import"
---

<objective>
Add input validation to the TUI settings edit flow so invalid paths and out-of-range numeric values are rejected with clear error messages and re-prompted.

Purpose: Prevent users from saving invalid configuration that would cause failures during build/flash workflows.
Output: New validation.py module with pure validator functions; updated tui.py with validation loops in the numeric and path edit branches.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@kflash/tui.py (lines 583-661 — _config_screen function)
@kflash/screen.py (SETTINGS list defines setting metadata)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation.py with pure validator functions</name>
  <files>kflash/validation.py</files>
  <action>
Create `kflash/validation.py` with two public functions:

1. `validate_numeric_setting(raw: str, min_val: float, max_val: float) -> tuple[bool, float | None, str]`
   - Returns (is_valid, parsed_value, error_message)
   - Rejects non-numeric input: `"Not a number"`
   - Rejects out-of-range: `"Must be between {min_val} and {max_val}"`
   - On success: `(True, parsed_float, "")`

2. `validate_path_setting(raw: str, setting_key: str) -> tuple[bool, str]`
   - Expands `~` via `os.path.expanduser()` on the raw input
   - Checks expanded path is an existing directory (`os.path.isdir`)
   - If setting_key is `"klipper_dir"`: also checks `Makefile` exists in that directory
   - If setting_key is `"katapult_dir"`: also checks `scripts/flashtool.py` exists in that directory
   - If setting_key is `"config_cache_dir"`: directory existence only
   - Returns `(True, "")` on success, `(False, "error message")` on failure
   - Error messages: `"Directory does not exist: {expanded}"`, `"Missing expected file: {path}"`

Use `from __future__ import annotations`. No external dependencies. Keep functions pure (no I/O beyond os.path checks).
  </action>
  <verify>python -c "from kflash.validation import validate_numeric_setting, validate_path_setting; print('OK')"</verify>
  <done>Both functions importable, handle all validation cases described above</done>
</task>

<task type="auto">
  <name>Task 2: Wire validation into tui.py settings edit flow</name>
  <files>kflash/tui.py</files>
  <action>
Modify `_config_screen()` in `kflash/tui.py` (lines 635-661) to add validation loops:

**Numeric branch (lines 635-650):** Replace the current try/except block with a validation loop:
```python
elif setting["type"] == "numeric":
    print(key)
    while True:
        try:
            raw = input(f"  {setting['label']} [{current}]: ").strip()
        except (EOFError, KeyboardInterrupt):
            raw = ""
            break
        if not raw:
            break
        ok, val, err = validate_numeric_setting(raw, setting["min"], setting["max"])
        if ok:
            new_gc = dataclasses.replace(gc, **{field_key: val})
            registry.save_global(new_gc)
            break
        else:
            print(f"  {theme.error}{err}{theme.reset}")
    continue
```

**Path branch (lines 652-661):** Replace with a validation loop:
```python
elif setting["type"] == "path":
    print(key)
    while True:
        try:
            raw = input(f"  {setting['label']} [{current}]: ").strip()
        except (EOFError, KeyboardInterrupt):
            raw = ""
            break
        if not raw:
            break
        ok, err = validate_path_setting(raw, field_key)
        if ok:
            new_gc = dataclasses.replace(gc, **{field_key: raw})
            registry.save_global(new_gc)
            break
        else:
            print(f"  {theme.error}{err}{theme.reset}")
    continue
```

Add import at top of function: `from .validation import validate_numeric_setting, validate_path_setting`

IMPORTANT: Store the user's original input (`raw`) in GlobalConfig, NOT the expanded path. Expansion is only for validation.

Also ensure SETTINGS in `screen.py` has `"min"` and `"max"` keys for numeric settings. Check current SETTINGS definition — if min/max are missing, add them:
- stagger_delay: min=0, max=30
- return_delay: min=0, max=60
  </action>
  <verify>
SSH to Pi and test manually:
1. Run settings screen, edit klipper_dir to `/nonexistent` — should show error and re-prompt
2. Edit stagger_delay to `50` — should show "Must be between 0 and 30" and re-prompt
3. Edit stagger_delay to `abc` — should show "Not a number" and re-prompt
4. Enter empty input — should cancel without changes
  </verify>
  <done>All path and numeric settings validate input before saving, rejecting invalid values with clear errors and re-prompting</done>
</task>

</tasks>

<verification>
1. Invalid klipper_dir (nonexistent or missing Makefile) is rejected with error, re-prompted
2. Invalid katapult_dir (nonexistent or missing scripts/flashtool.py) is rejected with error, re-prompted
3. Invalid config_cache_dir (nonexistent) is rejected with error, re-prompted
4. Paths with ~ are expanded for validation but stored as-is
5. stagger_delay outside 0-30 rejected with bounds error
6. return_delay outside 0-60 rejected with bounds error
7. Non-numeric input rejected with "Not a number"
8. Empty input cancels edit gracefully
</verification>

<success_criteria>
All 10 requirements (PATH-01 through PATH-07, NUM-01 through NUM-03) satisfied. Settings edit flow rejects invalid input at edit time with clear messages and re-prompts until valid input or cancellation.
</success_criteria>

<output>
After completion, create `.planning/phases/15-config-validation/15-01-SUMMARY.md`
</output>
