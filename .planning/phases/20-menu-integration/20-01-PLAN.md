---
phase: 20-menu-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - kflash/screen.py
  - kflash/tui.py
autonomous: true

must_haves:
  truths:
    - "Pressing E in main menu launches device config screen for selected device"
    - "User sees numbered device selection prompt before config screen (auto-selects if only one device)"
    - "Step dividers appear between device selection and config screen, and after config screen exits"
    - "No devices registered shows warning message and returns to menu"
    - "Actions panel shows Config Device with E key in correct order"
  artifacts:
    - path: "kflash/screen.py"
      provides: "ACTIONS list with E) Config Device in correct order"
      contains: '("E", "Config Device")'
    - path: "kflash/tui.py"
      provides: "E key dispatch handler in run_menu"
      contains: 'elif key == "e"'
  key_links:
    - from: "kflash/tui.py"
      to: "_device_config_screen"
      via: "E key dispatch calls _device_config_screen after device selection"
      pattern: '_device_config_screen\(device_key'
    - from: "kflash/tui.py"
      to: "_prompt_device_number"
      via: "E key dispatch reuses existing device selection"
      pattern: '_prompt_device_number\(device_map'
---

<objective>
Wire the "E" key to launch the device config screen from the main menu, with device selection prompt and step dividers.

Purpose: Final integration phase — connects the device config screen (Phase 19) to the main menu so users can access it.
Output: Modified screen.py (ACTIONS reorder) and tui.py (E key handler with device selection, dividers, save summary).
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-menu-integration/20-CONTEXT.md
@.planning/phases/20-menu-integration/20-RESEARCH.md
@kflash/screen.py
@kflash/tui.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reorder ACTIONS list and add E) Config Device</name>
  <files>kflash/screen.py</files>
  <action>
Update the ACTIONS list in screen.py to match the required panel ordering from CONTEXT.md:
Flash > Flash All > Add > Config > Remove > Settings > Quit

New ACTIONS list should be:
```python
ACTIONS: list[tuple[str, str]] = [
    ("F", "Flash Device"),
    ("B", "Flash All"),
    ("A", "Add Device"),
    ("E", "Config Device"),
    ("R", "Remove Device"),
    ("C", "Settings"),
    ("Q", "Quit"),
]
```

Note: The "D" (Refresh) key should be removed from the ACTIONS panel display list since CONTEXT.md does not include it. Keep the "D" key functional in the tui.py dispatch — it just won't appear in the actions panel.
  </action>
  <verify>Read screen.py and confirm ACTIONS contains exactly 7 entries in the specified order with ("E", "Config Device") at position 4.</verify>
  <done>ACTIONS list has correct order: F, B, A, E, R, C, Q. "D" key removed from display list.</done>
</task>

<task type="auto">
  <name>Task 2: Add E key dispatch handler in run_menu</name>
  <files>kflash/tui.py</files>
  <action>
Add an `elif key == "e":` branch in the `run_menu` function's key dispatch block, following the exact pattern of the "R" (Remove) handler. The handler should:

1. Print the key echo and newline (matches other handlers)
2. Check if `device_map` is empty — if so, set `status_message = "No devices registered. Use Add Device first."` and `status_level = "warning"`
3. Otherwise call `_prompt_device_number(device_map, out)` to get `device_key`
4. If `device_key` is None (user cancelled), set `status_message = "Config: no device selected"` and `status_level = "warning"`
5. If `device_key` is valid:
   a. Print `render_action_divider()` (step divider between selection and config screen)
   b. Call `_device_config_screen(device_key, registry, out)`
   c. Print `render_action_divider()` (step divider after config screen exits)
   d. Set a brief status message like `status_message = "Returned from device config"` and `status_level = "info"`
   e. Call `_countdown_return(registry.load().global_config.return_delay)` for consistency with other actions

Also update the unknown key hint string (the fallback else clause) to include "E" in the list of valid keys.

Note: `render_action_divider` is already imported in tui.py from panels. If not, add the import.

Note: _device_config_screen returns a summary string (or None). If it returns a non-empty string, use that as the status_message with level "success". If it returns None or empty, use the generic "Returned from device config" with level "info". Check the actual return type of _device_config_screen — if it returns None always, just use the generic message.
  </action>
  <verify>Read the run_menu function in tui.py and confirm:
1. "e" key has a dispatch handler
2. Empty device_map check is present
3. _prompt_device_number is called for device selection
4. render_action_divider() is called before and after _device_config_screen
5. Unknown key hint includes "E"
  </verify>
  <done>E key handler is wired into run_menu with device selection, dividers, edge case handling, and updated hint string.</done>
</task>

</tasks>

<verification>
1. Read screen.py ACTIONS list — confirms order F, B, A, E, R, C, Q
2. Read tui.py run_menu — confirms "e" key dispatch exists with all required wiring
3. Grep for "Config Device" in screen.py — confirms action label
4. Grep for 'key == "e"' in tui.py — confirms handler exists
5. Grep for render_action_divider in the E handler block — confirms dividers present
</verification>

<success_criteria>
- ACTIONS panel shows "E) Config Device" between Add and Remove
- Pressing E with no devices shows warning and returns to menu
- Pressing E with devices shows numbered selection, then config screen with dividers
- Unknown key hint includes E
- After config screen exit, countdown and return to main menu
</success_criteria>

<output>
After completion, create `.planning/phases/20-menu-integration/20-01-SUMMARY.md`
</output>
