---
phase: 25-key-internalization-in-tui
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - kflash/screen.py
  - kflash/tui.py
  - kflash/output.py
autonomous: true

must_haves:
  truths:
    - "Device config screen has no key edit option"
    - "All user-facing output shows entry.name, never entry.key"
    - "Flash failure messages reference device by display name"
    - "Device list shows name and MCU, not key"
    - "Flash All batch results show display names"
    - "Existing devices.json keys are never modified or re-derived"
  artifacts:
    - path: "kflash/screen.py"
      provides: "DEVICE_SETTINGS without key entry"
    - path: "kflash/tui.py"
      provides: "Updated config screen handlers and key-free output"
    - path: "kflash/output.py"
      provides: "mcu_mismatch_choice uses name not key"
  key_links:
    - from: "kflash/tui.py"
      to: "kflash/screen.py"
      via: "DEVICE_SETTINGS list consumed by config screen"
      pattern: "DEVICE_SETTINGS"
---

<objective>
Remove key edit from device config screen and replace all user-facing `entry.key` / `device_key` references with `entry.name` across the codebase.

Purpose: Device keys must be completely invisible to users â€” all output shows display names only.
Output: Modified screen.py (DEVICE_SETTINGS), tui.py (config screen handlers, flash output), output.py (mcu mismatch).
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-key-internalization-in-tui/25-CONTEXT.md
@.planning/phases/25-key-internalization-in-tui/25-RESEARCH.md
@kflash/screen.py
@kflash/tui.py
@kflash/output.py
@kflash/flash.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove key edit from DEVICE_SETTINGS and update config screen</name>
  <files>kflash/screen.py, kflash/tui.py</files>
  <action>
**screen.py:**
1. Remove the `{"key": "key", "label": "Device key", ...}` entry from `DEVICE_SETTINGS` list (line ~481). The list should go from 5 entries to 4: name, flash_method, flashable, menuconfig.

**tui.py `_device_config_screen` (lines ~768-941):**
1. Update the key range check from `("1", "2", "3", "4", "5")` to `("1", "2", "3", "4")`.
2. Remove the `elif setting["key"] == "key"` handler block (lines ~837-851) that handles key editing/validation.
3. Verify remaining handlers still dispatch correctly with new indices:
   - 1 = name (text edit)
   - 2 = flash_method (cycle)
   - 3 = flashable (toggle)
   - 4 = menuconfig (action)

**tui.py `_save_device_edits` (lines ~734-765):**
1. Remove the `new_key` branch that handles key renaming (moving cache dirs, rewriting registry under new key). This code is dead now that key editing is impossible. Keep the name-change and other-field-change logic intact.
  </action>
  <verify>
  - Grep for `"Device key"` in screen.py -- should not appear in DEVICE_SETTINGS
  - Count DEVICE_SETTINGS entries -- should be 4
  - Grep for `setting\["key"\] == "key"` in tui.py -- should not appear
  - Grep for `new_key` in _save_device_edits -- should not appear (or be minimal)
  - Manually confirm each option 1-4 dispatches to the correct handler: 1=name, 2=flash_method, 3=flashable, 4=menuconfig
  </verify>
  <done>
  - DEVICE_SETTINGS has 4 entries (no key edit)
  - Config screen dispatches correctly on indices 1-4 (each option verified to reach correct handler)
  - Key rename logic removed from _save_device_edits
  - No way for users to see or edit device keys in config screen
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace entry.key/device_key with entry.name in flash.py user-facing output</name>
  <files>kflash/flash.py</files>
  <action>
Replace user-facing `entry.key` or `device_key` with `entry.name` in flash.py display strings ONLY. Do NOT change internal logic (registry lookups, cache paths, DeviceEntry creation, `--device` CLI flag handling).

**Scope rule for `device_key` contexts:** Where `device_key` is a parameter but `entry` is not in scope, look up via `entry = registry.get(device_key)` before accessing `entry.name`, or pass `name` as a separate parameter. Check each function's signature and local scope before replacing.

**Specific changes:**
- Line ~344: `_action_flash_device` failure message -- `device_key` is a parameter here; `entry` may not be in scope. Look up `entry = registry.get(device_key)` or use the `entry` variable if already fetched earlier in the function, then use `entry.name`.
- Line ~440: `_action_remove_device` success -- replace `device_key` with `entry.name` (look up entry if not in scope)
- Line ~509: `cmd_flash` duplicate USB display -- replace `entry.key` with `entry.name`
- Line ~566: `cmd_list_devices` format -- change `f"{entry.key}: {entry.name} ({entry.mcu})"` to `f"{entry.name} ({entry.mcu})"` or similar name-first format
- Line ~580: excluded devices display -- replace `entry.key` with `entry.name`
- Line ~608: flashable device list -- replace `entry.key` with `entry.name`
- Line ~1124: flash_all blocked -- remove `({entry.key})`, show just `entry.name`
- Line ~1172: flash_all config ages -- remove `({entry.key})`, show just `entry.name`
- Line ~1219/1222: flash_all version -- remove `({entry.key})`, show just `entry.name`
- Line ~1407: `cmd_remove_device` confirm -- replace key with name
- Line ~1412: remove success -- replace key with name
  </action>
  <verify>
  ```bash
  grep -n "entry\.key\|device_key" kflash/flash.py
  ```
  Inspect each remaining hit to confirm it's internal-only (registry lookup, cache path, etc.), not user-facing output.
  </verify>
  <done>
  - All flash.py user-facing strings show entry.name, never entry.key or device_key
  - Where entry was not in scope, it is properly looked up from registry
  - Internal key usage preserved
  </done>
</task>

<task type="auto">
  <name>Task 3: Replace entry.key/device_key with entry.name in tui.py and output.py</name>
  <files>kflash/tui.py, kflash/output.py</files>
  <action>
Replace user-facing `entry.key` or `device_key` with `entry.name` in tui.py and output.py display strings ONLY.

**Scope rule:** Where `device_key` is a parameter but `entry` is not in scope, look up via `entry = registry.get(device_key)` before accessing `entry.name`, or pass `name` as a separate parameter.

**tui.py changes:**
- Line ~344: `_action_flash_device` failure -- `device_key` is a parameter; check if `entry` is available in scope. If not, look up `entry = registry.get(device_key)` then use `entry.name`.

**output.py changes:**
- Line ~103: `mcu_mismatch_choice` -- replace `device '{device_key}'` parameter/display with device name. Update the function signature to accept `device_name: str` instead of (or in addition to) `device_key`, and update all callers.
  </action>
  <verify>
  ```bash
  grep -n "entry\.key\|device_key" kflash/tui.py kflash/output.py
  ```
  Inspect each remaining hit to confirm it's internal-only, not user-facing output.
  </verify>
  <done>
  - tui.py and output.py user-facing strings show entry.name, never entry.key or device_key
  - mcu_mismatch_choice uses display name
  - Internal key usage preserved
  </done>
</task>

</tasks>

<verification>
```bash
# Comprehensive key leakage check -- every hit should be internal-only
grep -n "entry\.key\|device_key" kflash/flash.py kflash/tui.py kflash/output.py kflash/screen.py | grep -vi "registry\|cache\|config_dir\|devices\["
# Should return zero results or only programmatic assignments

# DEVICE_SETTINGS count
grep -c "key.*label.*type" kflash/screen.py  # Should be 4

# Confirm no key edit handler
grep -c 'setting.*key.*==.*"key"' kflash/tui.py  # Should be 0
```
</verification>

<success_criteria>
- Device config screen has exactly 4 settings (no key edit)
- Zero user-facing output contains entry.key or device_key
- All flash/list/remove/batch messages show display names
- Internal key usage preserved for registry and cache operations
- Existing devices.json untouched (no migration, no re-derivation)
</success_criteria>

<output>
After completion, create `.planning/phases/25-key-internalization-in-tui/25-02-SUMMARY.md`
</output>
