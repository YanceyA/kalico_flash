---
phase: 25-key-internalization-in-tui
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - kflash/screen.py
  - kflash/tui.py
  - kflash/output.py
autonomous: true

must_haves:
  truths:
    - "Device config screen has no key edit option"
    - "All user-facing output shows entry.name, never entry.key"
    - "Flash failure messages reference device by display name"
    - "Device list shows name and MCU, not key"
    - "Flash All batch results show display names"
    - "Existing devices.json keys are never modified or re-derived"
  artifacts:
    - path: "kflash/screen.py"
      provides: "DEVICE_SETTINGS without key entry"
    - path: "kflash/tui.py"
      provides: "Updated config screen handlers and key-free output"
    - path: "kflash/output.py"
      provides: "mcu_mismatch_choice uses name not key"
  key_links:
    - from: "kflash/tui.py"
      to: "kflash/screen.py"
      via: "DEVICE_SETTINGS list consumed by config screen"
      pattern: "DEVICE_SETTINGS"
---

<objective>
Remove key edit from device config screen and replace all user-facing `entry.key` / `device_key` references with `entry.name` across the codebase.

Purpose: Device keys must be completely invisible to users — all output shows display names only.
Output: Modified screen.py (DEVICE_SETTINGS), tui.py (config screen handlers, flash output), output.py (mcu mismatch).
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-key-internalization-in-tui/25-CONTEXT.md
@.planning/phases/25-key-internalization-in-tui/25-RESEARCH.md
@kflash/screen.py
@kflash/tui.py
@kflash/output.py
@kflash/flash.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove key edit from DEVICE_SETTINGS and update config screen</name>
  <files>kflash/screen.py, kflash/tui.py</files>
  <action>
**screen.py:**
1. Remove the `{"key": "key", "label": "Device key", ...}` entry from `DEVICE_SETTINGS` list (line ~481). The list should go from 5 entries to 4: name, flash_method, flashable, menuconfig.

**tui.py `_device_config_screen` (lines ~768-941):**
1. Update the key range check from `("1", "2", "3", "4", "5")` to `("1", "2", "3", "4")`.
2. Remove the `elif setting["key"] == "key"` handler block (lines ~837-851) that handles key editing/validation.
3. Verify remaining handlers still dispatch correctly with new indices:
   - 1 = name (text edit)
   - 2 = flash_method (cycle)
   - 3 = flashable (toggle)
   - 4 = menuconfig (action)

**tui.py `_save_device_edits` (lines ~734-765):**
1. Remove the `new_key` branch that handles key renaming (moving cache dirs, rewriting registry under new key). This code is dead now that key editing is impossible. Keep the name-change and other-field-change logic intact.
  </action>
  <verify>
  - Grep for `"Device key"` in screen.py -- should not appear in DEVICE_SETTINGS
  - Count DEVICE_SETTINGS entries -- should be 4
  - Grep for `setting\["key"\] == "key"` in tui.py -- should not appear
  - Grep for `new_key` in _save_device_edits -- should not appear (or be minimal)
  </verify>
  <done>
  - DEVICE_SETTINGS has 4 entries (no key edit)
  - Config screen dispatches correctly on indices 1-4
  - Key rename logic removed from _save_device_edits
  - No way for users to see or edit device keys in config screen
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace entry.key with entry.name in all user-facing output</name>
  <files>kflash/tui.py, kflash/output.py, kflash/flash.py</files>
  <action>
Audit and replace every user-facing `entry.key` or `device_key` string with `entry.name`. Only change OUTPUT/DISPLAY strings — do NOT change internal logic that uses keys for registry lookups, cache paths, or DeviceEntry creation.

**flash.py changes (from research audit):**
- Line ~344: `_action_flash_device` failure message -- replace `device_key` with `entry.name`
- Line ~440: `_action_remove_device` success -- replace `device_key` with `entry.name`
- Line ~509: `cmd_flash` duplicate USB display -- replace `entry.key` with `entry.name`
- Line ~566: `cmd_list_devices` format -- change `f"{entry.key}: {entry.name} ({entry.mcu})"` to `f"{entry.name} ({entry.mcu})"` or similar name-first format
- Line ~580: excluded devices display -- replace `entry.key` with `entry.name`
- Line ~608: flashable device list -- replace `entry.key` with `entry.name`
- Line ~1124: flash_all blocked -- remove `({entry.key})`, show just `entry.name`
- Line ~1172: flash_all config ages -- remove `({entry.key})`, show just `entry.name`
- Line ~1219/1222: flash_all version -- remove `({entry.key})`, show just `entry.name`
- Line ~1407: `cmd_remove_device` confirm -- replace key with name
- Line ~1412: remove success -- replace key with name

**tui.py changes:**
- Line ~344: `_action_flash_device` failure -- replace `device_key` with `entry.name` (entry should be available in scope; if not, look up from registry)

**output.py changes:**
- Line ~103: `mcu_mismatch_choice` -- replace `device '{device_key}'` parameter/display with device name

**Important:** Do NOT change:
- Internal registry lookups using `device_key` as dict key
- Config cache path construction using key
- `--device` CLI flag handling
- Any variable assignments where key is used programmatically
  </action>
  <verify>
  ```bash
  # After changes, search for remaining key leakage in user-facing strings
  # These greps should return only internal/programmatic uses, not display strings:
  grep -n "entry\.key" kflash/flash.py kflash/tui.py kflash/output.py
  grep -n "device_key" kflash/flash.py kflash/tui.py kflash/output.py
  ```
  Manually inspect each remaining hit to confirm it's internal-only (registry lookup, cache path, etc.), not user-facing output.
  </verify>
  <done>
  - All user-facing strings show entry.name or display name, never entry.key
  - Flash failure/success messages use display names
  - Device list shows names not keys
  - Flash All batch output shows names not keys
  - Remove device confirmation uses name
  - mcu_mismatch_choice uses name
  - Internal key usage (registry, cache, CLI flag) unchanged
  </done>
</task>

</tasks>

<verification>
```bash
# Comprehensive key leakage check -- every hit should be internal-only
grep -n "entry\.key\|device_key" kflash/flash.py kflash/tui.py kflash/output.py kflash/screen.py | grep -vi "registry\|cache\|config_dir\|devices\["
# Should return zero results or only programmatic assignments

# DEVICE_SETTINGS count
grep -c "key.*label.*type" kflash/screen.py  # Should be 4

# Confirm no key edit handler
grep -c 'setting.*key.*==.*"key"' kflash/tui.py  # Should be 0
```
</verification>

<success_criteria>
- Device config screen has exactly 4 settings (no key edit)
- Zero user-facing output contains entry.key or device_key
- All flash/list/remove/batch messages show display names
- Internal key usage preserved for registry and cache operations
- Existing devices.json untouched (no migration, no re-derivation)
</success_criteria>

<output>
After completion, create `.planning/phases/25-key-internalization-in-tui/25-02-SUMMARY.md`
</output>
