---
phase: 25-key-internalization-in-tui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - kflash/flash.py
autonomous: true

must_haves:
  truths:
    - "Add-device wizard prompts only for display name, never for device key"
    - "Duplicate display names are rejected with case-insensitive check and re-prompt"
    - "Device key is auto-generated silently via generate_device_key()"
    - "ValueError from generate_device_key on invalid names is caught and shows helpful error"
    - "Confirmation message shows display name only, not the generated key"
  artifacts:
    - path: "kflash/flash.py"
      provides: "Rewired add-device wizard with auto-key generation"
      contains: "generate_device_key"
  key_links:
    - from: "kflash/flash.py"
      to: "kflash/validation.py"
      via: "generate_device_key import and call"
      pattern: "generate_device_key"
---

<objective>
Remove the device key prompt from the add-device wizard and wire in automatic key generation via `generate_device_key()`.

Purpose: Users should never see or type device keys — keys are internal identifiers only.
Output: Modified `cmd_add_device()` in flash.py with key prompt removed, duplicate name check added, and silent key auto-generation.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-key-internalization-in-tui/25-CONTEXT.md
@.planning/phases/25-key-internalization-in-tui/25-RESEARCH.md
@kflash/flash.py
@kflash/validation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove key prompt, add duplicate name check, wire generate_device_key()</name>
  <files>kflash/flash.py</files>
  <action>
In `cmd_add_device()` (around lines 1813-1933):

1. **Delete the key prompt block** (lines ~1813-1827): Remove the entire loop that prompts for device key, validates it, and checks for duplicate keys.

2. **Enhance the display name prompt** (lines ~1834-1837): Replace the simple one-line prompt with a loop that:
   - Prompts for display name
   - Rejects empty input with warning
   - Performs case-insensitive duplicate check against existing device names: `{e.name.lower() for e in registry_data.devices.values()}`
   - If duplicate: `out.warn(f"You already have a device named '{name_input}'. Enter a different name.")`
   - Allows 3 attempts, then exits with error

3. **Auto-generate key after name prompt**: After display_name is set:
   ```python
   from kflash.validation import generate_device_key
   try:
       device_key = generate_device_key(display_name, registry)
   except ValueError:
       out.error("Display name must contain at least one letter or number.")
       return 1
   ```
   Note: The import should be at the top of the function or with the other late imports, not inline.

4. **Update the success message** (line ~1933): Change from `f"Registered '{device_key}' ({display_name})"` to show only the display name, e.g., `f"Device '{display_name}' added successfully."`

5. **Ensure `device_key` variable** is still set correctly for the `DeviceEntry` creation and `registry.save()` call that follows — those use `device_key` as the dict key internally and must continue working.
  </action>
  <verify>
  - Grep for the old key prompt text (e.g., "Device key") in cmd_add_device to confirm removal
  - Grep for `generate_device_key` to confirm it's called
  - Grep for duplicate name check (`name.lower()` or similar) to confirm it exists
  - Verify `device_key` is still used in DeviceEntry creation
  </verify>
  <done>
  - Key prompt is completely removed from add-device wizard
  - Display name prompt has 3-attempt loop with duplicate name detection (case-insensitive)
  - Key is auto-generated via generate_device_key(display_name, registry)
  - ValueError is caught with user-friendly message
  - Success message shows only display name
  - DeviceEntry creation still receives the generated key
  </done>
</task>

</tasks>

<verification>
```bash
# Confirm key prompt removed
grep -n "Device key" kflash/flash.py  # Should not appear in prompt context
# Confirm auto-generation wired
grep -n "generate_device_key" kflash/flash.py  # Should show import + call
# Confirm duplicate name check
grep -n "name.lower()" kflash/flash.py  # Should appear in add-device
# Confirm success message uses display name only
grep -n "added successfully\|Registered" kflash/flash.py  # Should show name-only message
```
</verification>

<success_criteria>
- Add-device wizard has no key prompt
- Duplicate display names rejected case-insensitively
- Key auto-generated silently
- ValueError handled gracefully
- Success message shows display name only
</success_criteria>

<output>
After completion, create `.planning/phases/25-key-internalization-in-tui/25-01-SUMMARY.md`
</output>
