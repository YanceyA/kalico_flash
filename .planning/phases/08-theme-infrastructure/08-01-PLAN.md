---
phase: 08-theme-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - kalico-flash/theme.py
autonomous: true

must_haves:
  truths:
    - "get_theme() returns Theme dataclass with semantic style fields"
    - "NO_COLOR=1 returns theme with all empty strings"
    - "FORCE_COLOR=1 returns theme with ANSI codes"
    - "supports_color() detects TTY and environment variables correctly"
    - "clear_screen() clears terminal without error"
    - "Multiple get_theme() calls return same cached instance"
  artifacts:
    - path: "kalico-flash/theme.py"
      provides: "Theme system with detection, dataclass, and utilities"
      exports: ["Theme", "get_theme", "reset_theme", "supports_color", "clear_screen"]
      min_lines: 100
  key_links:
    - from: "get_theme()"
      to: "supports_color()"
      via: "Detection call on first access"
      pattern: "_color_theme if supports_color\\(\\) else _no_color_theme"
    - from: "supports_color()"
      to: "_enable_windows_vt_mode()"
      via: "Windows platform detection"
      pattern: "sys\\.platform.*win.*_enable_windows_vt_mode"
---

<objective>
Create the theme.py module with semantic styling, terminal detection, and screen utilities.

Purpose: Provide centralized ANSI color support for all CLI output, following KIAUH-style theming. This module is the foundation for Phase 9 which will integrate theming across output.py, tui.py, and errors.py.

Output: `kalico-flash/theme.py` with Theme dataclass, supports_color() detection, get_theme()/reset_theme() singleton, and clear_screen() utility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/08-theme-infrastructure/08-RESEARCH.md
@kalico-flash/output.py (reference for Output protocol pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme.py module</name>
  <files>kalico-flash/theme.py</files>
  <action>
Create `kalico-flash/theme.py` implementing all 6 THEME requirements. Follow the implementation in 08-RESEARCH.md exactly:

**1. ANSI Constants (top of file):**
- RESET = "\033[0m"
- _GREEN = "\033[92m" (bright green)
- _YELLOW = "\033[93m" (bright yellow)
- _RED = "\033[91m" (bright red)
- _CYAN = "\033[96m" (bright cyan)
- _BOLD = "\033[1m"
- _DIM = "\033[2m"

**2. Theme dataclass (THEME-01):**
```python
@dataclass
class Theme:
    # Message types
    success: str = _GREEN
    warning: str = _YELLOW
    error: str = _RED
    info: str = _CYAN
    phase: str = _CYAN

    # Device markers
    marker_reg: str = _GREEN
    marker_new: str = _CYAN
    marker_blk: str = _RED
    marker_dup: str = _YELLOW
    marker_num: str = ""

    # UI elements
    menu_title: str = _BOLD
    menu_border: str = ""
    prompt: str = _BOLD

    # Modifiers
    bold: str = _BOLD
    dim: str = _DIM
    reset: str = RESET
```

**3. Theme instances:**
- _color_theme = Theme() (uses defaults)
- _no_color_theme = Theme(...) with ALL fields as empty strings

**4. supports_color() function (THEME-02):**
Detection order (return immediately on match):
1. os.environ.get("NO_COLOR") -> return False
2. os.environ.get("FORCE_COLOR") -> return True
3. not sys.stdout.isatty() -> return False
4. os.environ.get("TERM") == "dumb" -> return False
5. sys.platform == "win32" -> return _enable_windows_vt_mode()
6. else -> return True (Unix TTY)

**5. _enable_windows_vt_mode() helper (THEME-03):**
```python
def _enable_windows_vt_mode() -> bool:
    try:
        import ctypes
        kernel32 = ctypes.windll.kernel32
        STD_OUTPUT_HANDLE = -11
        ENABLE_VIRTUAL_TERMINAL_PROCESSING = 0x0004
        handle = kernel32.GetStdHandle(STD_OUTPUT_HANDLE)
        mode = ctypes.c_ulong()
        kernel32.GetConsoleMode(handle, ctypes.byref(mode))
        kernel32.SetConsoleMode(handle, mode.value | ENABLE_VIRTUAL_TERMINAL_PROCESSING)
        return True
    except Exception:
        return False
```

**6. Cached singleton (THEME-05):**
```python
_cached_theme: Theme | None = None

def get_theme() -> Theme:
    global _cached_theme
    if _cached_theme is None:
        _cached_theme = _color_theme if supports_color() else _no_color_theme
    return _cached_theme

def reset_theme() -> None:
    global _cached_theme
    _cached_theme = None
```

**7. clear_screen() utility (THEME-06):**
```python
def clear_screen() -> None:
    if sys.platform == "win32":
        if supports_color():
            # VT mode enabled, use ANSI
            print("\033[H\033[J", end="", flush=True)
        else:
            subprocess.run(["cmd", "/c", "cls"], check=False)
    else:
        # Unix: clear -x preserves scrollback
        result = subprocess.run(["clear", "-x"], capture_output=True)
        if result.returncode != 0:
            # Fallback to ANSI
            print("\033[H\033[J", end="", flush=True)
```

**File structure:**
1. Module docstring
2. Imports (from __future__ import annotations, sys, os, subprocess, dataclass)
3. ANSI constants
4. Theme dataclass
5. Theme instances (_color_theme, _no_color_theme)
6. _enable_windows_vt_mode()
7. supports_color()
8. _cached_theme, get_theme(), reset_theme()
9. clear_screen()

**Important:**
- Use `from __future__ import annotations` for forward references
- Docstrings for Theme class and public functions
- Keep private helpers prefixed with underscore
- Target ~120 lines total
  </action>
  <verify>
Run syntax check:
```bash
python3 -m py_compile kalico-flash/theme.py
```
Check imports work:
```bash
python3 -c "from kalico-flash.theme import Theme, get_theme, reset_theme, supports_color, clear_screen; print('Imports OK')"
```
  </verify>
  <done>theme.py exists with Theme dataclass and all required exports</done>
</task>

<task type="auto">
  <name>Task 2: Verify theme detection and behavior</name>
  <files>kalico-flash/theme.py</files>
  <action>
Test the theme module functionality:

**Test 1: Default detection (should return colored theme in terminal)**
```bash
python3 -c "
from theme import get_theme, supports_color
print(f'supports_color(): {supports_color()}')
t = get_theme()
print(f'success field: {repr(t.success)}')
print(f'reset field: {repr(t.reset)}')
"
```
Expected: supports_color() returns True on terminal, success contains ANSI code.

**Test 2: NO_COLOR environment variable**
```bash
NO_COLOR=1 python3 -c "
from theme import get_theme, reset_theme
reset_theme()  # Clear cache
t = get_theme()
print(f'success: {repr(t.success)}')
print(f'reset: {repr(t.reset)}')
"
```
Expected: Both fields are empty strings.

**Test 3: FORCE_COLOR environment variable**
```bash
FORCE_COLOR=1 python3 -c "
from theme import get_theme, reset_theme, supports_color
reset_theme()
print(f'supports_color: {supports_color()}')
t = get_theme()
print(f'success: {repr(t.success)}')
"
```
Expected: supports_color() returns True, success contains ANSI code.

**Test 4: Singleton caching**
```bash
python3 -c "
from theme import get_theme, reset_theme
t1 = get_theme()
t2 = get_theme()
print(f'Same instance: {t1 is t2}')
"
```
Expected: True

**Test 5: clear_screen() executes without error**
```bash
python3 -c "from theme import clear_screen; clear_screen(); print('clear_screen OK')"
```
Expected: Screen clears (or command completes), prints "clear_screen OK"

**Test 6: Theme dataclass has all required fields**
```bash
python3 -c "
from theme import Theme
import dataclasses
fields = [f.name for f in dataclasses.fields(Theme)]
required = ['success', 'warning', 'error', 'info', 'phase',
            'marker_reg', 'marker_new', 'marker_blk', 'marker_dup', 'marker_num',
            'menu_title', 'menu_border', 'prompt', 'bold', 'dim', 'reset']
missing = [f for f in required if f not in fields]
print(f'Missing fields: {missing}' if missing else 'All fields present')
"
```
Expected: All fields present

Run tests from kalico-flash directory (cd kalico-flash first).

If any test fails, fix the issue in theme.py.
  </action>
  <verify>
All 6 tests pass without errors.
  </verify>
  <done>
- supports_color() returns True in TTY, False with NO_COLOR=1
- FORCE_COLOR=1 overrides to True
- get_theme() returns Theme instance
- Multiple get_theme() calls return same instance
- clear_screen() executes without error
- Theme has all 16 semantic fields
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **File exists and is syntactically valid:**
   ```bash
   python3 -m py_compile kalico-flash/theme.py
   ```

2. **All exports available:**
   ```bash
   python3 -c "from kalico-flash.theme import Theme, get_theme, reset_theme, supports_color, clear_screen"
   ```

3. **NO_COLOR respected:**
   ```bash
   NO_COLOR=1 python3 -c "from kalico-flash.theme import get_theme; t=get_theme(); print(repr(t.success))"
   # Output: ''
   ```

4. **Color theme has ANSI codes:**
   ```bash
   FORCE_COLOR=1 python3 -c "from kalico-flash.theme import get_theme, reset_theme; reset_theme(); t=get_theme(); print(repr(t.success))"
   # Output: '\x1b[92m'
   ```
</verification>

<success_criteria>
- kalico-flash/theme.py exists (~100-130 lines)
- Theme dataclass has all 16 semantic fields
- supports_color() implements full detection chain (NO_COLOR, FORCE_COLOR, TTY, TERM, Windows VT)
- get_theme() returns cached singleton
- reset_theme() clears cache
- clear_screen() works on Unix (primary target)
- All verification commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-theme-infrastructure/08-01-SUMMARY.md`
</output>
