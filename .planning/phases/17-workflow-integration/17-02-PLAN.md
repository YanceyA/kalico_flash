---
phase: 17-workflow-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [kflash/flash.py]
autonomous: true

must_haves:
  truths:
    - "cmd_flash_all() has step_divider() calls between major stages (validation, version, build, flash, summary)"
    - "cmd_flash_all() has device_divider() calls between devices in build loop (skipping first)"
    - "cmd_flash_all() has device_divider() calls between devices in flash loop (skipping first)"
    - "No dividers appear inside the summary table or inside error blocks"
  artifacts:
    - path: "kflash/flash.py"
      provides: "Divider calls in cmd_flash_all"
      contains: "out.device_divider("
  key_links:
    - from: "kflash/flash.py"
      to: "kflash/output.py"
      via: "out.step_divider() and out.device_divider() method calls"
      pattern: "out\\.device_divider\\("
---

<objective>
Add step dividers and device dividers to the cmd_flash_all() batch workflow.

Purpose: Provide visual separation between Flash All stages (validation, version check, build, flash, summary) and between individual devices within build and flash loops.
Output: flash.py updated with step_divider() and device_divider() calls in cmd_flash_all().
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-workflow-integration/17-RESEARCH.md
@kflash/flash.py
@kflash/output.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stage dividers to cmd_flash_all()</name>
  <files>kflash/flash.py</files>
  <action>
In cmd_flash_all(), insert `out.step_divider()` between major stages (4 calls total):
1. After validation stage completes, before version check section (`host_version = get_host_klipper_version(...)`)
2. After version check, before build stage (`out.phase("Flash All", f"Building firmware...")`)
3. After build stage completes, before flash stage (`out.phase("Flash All", f"Flashing...")`)
4. After flash stage completes (after service restart), before summary table (`out.phase("Flash All", "Summary:")`)

Rules:
- Do NOT place a divider before the first stage (validation)
- Do NOT place dividers inside the summary table loop
- Do NOT place dividers inside `except` or `finally` blocks
- Place dividers BEFORE the new stage's first line, not after the old stage's last line
  </action>
  <verify>
Search cmd_flash_all() for `step_divider` calls. Should find 4 calls. None inside the summary results loop.
  </verify>
  <done>cmd_flash_all() has 4 step_divider() calls separating validation/version/build/flash/summary stages.</done>
</task>

<task type="auto">
  <name>Task 2: Add device dividers to build and flash loops</name>
  <files>kflash/flash.py</files>
  <action>
In cmd_flash_all() build loop, add device_divider() between devices:
```python
for i, (entry, result) in enumerate(zip(flash_list, results)):
    if i > 0:
        out.device_divider(i + 1, total, entry.name)
    # ... existing build logic ...
```

In cmd_flash_all() flash loop, add device_divider() between devices:
```python
flash_idx = 0
for entry, result in built_results:
    if flash_idx > 0:
        out.device_divider(flash_idx + 1, flash_total, entry.name)
    flash_idx += 1
    # ... existing flash logic ...
```

Rules:
- Use `i > 0` / `flash_idx > 0` guard to skip divider before first device
- Use 1-based indexing for the displayed number: `i + 1`, `flash_idx + 1`
- `total` = len(flash_list) for build, `flash_total` = len(built_results) for flash
- Pass `entry.name` as the device name parameter
- Read actual code to find the exact loop variables and structure â€” adapt the pattern above to match

Note: The flash loop may use different variable names or iteration patterns. Read the actual code carefully and adapt. The key contract is: `out.device_divider(current_1based, total, name)` when not the first device.
  </action>
  <verify>
Search cmd_flash_all() for `device_divider` calls. Should find 2 calls (one in build loop, one in flash loop). Both should be guarded by `if ... > 0:`.
  </verify>
  <done>cmd_flash_all() shows labeled device dividers between each device in both build and flash loops. First device has no preceding divider. Device numbers are 1-based.</done>
</task>

</tasks>

<verification>
1. `grep -c "device_divider" kflash/flash.py` returns 2
2. `grep -c "step_divider" kflash/flash.py` returns 18 (14 from plan 01 + 4 from plan 02)
3. Both device_divider calls are guarded by `> 0` check
4. No dividers inside summary table loop
5. `python3 flash.py --help` still works (no syntax errors)
</verification>

<success_criteria>
- cmd_flash_all() has 4 step_divider() calls between stages
- cmd_flash_all() has 2 device_divider() calls (build loop + flash loop)
- Device dividers skip first device (i > 0 guard)
- Device dividers use 1-based numbering
- No dividers inside summary table or error blocks
- Code passes syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/17-workflow-integration/17-02-SUMMARY.md`
</output>
