---
phase: 17-workflow-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [kflash/flash.py]
autonomous: true

must_haves:
  truths:
    - "cmd_flash() has step_divider() calls between Discovery, Safety, Version, Config, Build, and Flash phases"
    - "cmd_add_device() has step_divider() calls before each wizard prompt section"
    - "cmd_remove_device() has step_divider() before confirmation and before result"
    - "No dividers appear inside error blocks, countdown timers, or after final messages"
  artifacts:
    - path: "kflash/flash.py"
      provides: "Divider calls in cmd_flash, cmd_add_device, cmd_remove_device"
      contains: "out.step_divider()"
  key_links:
    - from: "kflash/flash.py"
      to: "kflash/output.py"
      via: "out.step_divider() method calls"
      pattern: "out\\.step_divider\\(\\)"
---

<objective>
Add step dividers to the three single-device command workflows: cmd_flash(), cmd_add_device(), and cmd_remove_device().

Purpose: Provide visual separation between workflow phases so users can see where one step ends and the next begins.
Output: flash.py updated with step_divider() calls at all identified insertion points for these three commands.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-workflow-integration/17-RESEARCH.md
@kflash/flash.py
@kflash/output.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add step dividers to cmd_flash() and cmd_remove_device()</name>
  <files>kflash/flash.py</files>
  <action>
In cmd_flash(), insert `out.step_divider()` at these phase boundaries (5 calls total):
1. After Discovery phase completes, before the Moonraker safety check section
2. After safety check, before version information section
3. After version info, before Config phase (`out.phase("Config", ...)`)
4. After Config phase completes, before Build phase (`out.phase("Build", ...)`)
5. After Build phase completes, before Flash phase (`out.phase("Flash", ...)`)

Rules:
- Place divider BEFORE the first line of the new phase, not after the last line of the old phase
- Do NOT place dividers inside `except` blocks or after `error_with_recovery()` calls
- Do NOT place dividers inside the `wait_for_device()` countdown loop
- Do NOT place a divider after the final success message before return
- Do NOT place a divider before the very first phase (Discovery)
- If a phase is conditional (e.g., version info only shows when host_version exists), place the divider BEFORE the conditional so it always executes

In cmd_remove_device(), insert `out.step_divider()` at 2 points:
1. After loading the device entry (and after the not-found error check), before the confirmation prompt
2. After the user confirms removal, before the registry.remove() call and success message

Read the actual code to find exact insertion points — the research line numbers are approximate.
  </action>
  <verify>
Search flash.py for `step_divider` calls. cmd_flash() should have 5 calls, cmd_remove_device() should have 2 calls. No step_divider() calls should appear inside `except` blocks or inside `wait_for_device`.
  </verify>
  <done>cmd_flash() shows step dividers between Discovery/Safety/Version/Config/Build/Flash phases. cmd_remove_device() shows step dividers before confirmation and before result. No dividers inside error blocks or countdown timers.</done>
</task>

<task type="auto">
  <name>Task 2: Add step dividers to cmd_add_device() wizard</name>
  <files>kflash/flash.py</files>
  <action>
In cmd_add_device(), insert `out.step_divider()` before each wizard section (7 calls total):
1. After device selection confirmation (`out.info("Selected", ...)`), before global config section
2. After global config section, before device key prompt
3. After device key accepted, before display name prompt
4. After display name entered, before MCU detection section
5. After MCU/serial pattern shown, before flash method prompt
6. After flash method set, before exclusion prompt
7. After exclusion answered, before final save and success message

Rules:
- Place divider BEFORE the section, not after the previous section's last line
- The global config section is conditional (only runs on first device) — place divider BEFORE the conditional so it always fires
- Do NOT place a divider inside the retry loops (device key 3-attempt loop, flash method 3-attempt loop)
- Do NOT place a divider after the final `out.success()` before return

Read the actual code to find exact insertion points — match the research mockup placement from dividers.txt.
  </action>
  <verify>
Search flash.py for `step_divider` calls within cmd_add_device(). Should find 7 calls. No calls inside `for attempt in range(3)` loops.
  </verify>
  <done>cmd_add_device() shows step dividers before each prompt section matching the mockup layout. 7 step_divider() calls placed at wizard section boundaries.</done>
</task>

</tasks>

<verification>
1. `grep -c "step_divider" kflash/flash.py` returns 14 (5 + 2 + 7)
2. No `step_divider` calls inside `except` blocks
3. No `step_divider` calls inside `wait_for_device` function or its callers' polling loops
4. No `step_divider` call after the final success/error message in any command
5. `python3 flash.py --help` still works (no syntax errors)
</verification>

<success_criteria>
- cmd_flash() has 5 step_divider() calls at phase boundaries
- cmd_add_device() has 7 step_divider() calls at wizard section boundaries
- cmd_remove_device() has 2 step_divider() calls
- No dividers inside error blocks, countdown timers, or after final messages
- Code passes syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/17-workflow-integration/17-01-SUMMARY.md`
</output>
