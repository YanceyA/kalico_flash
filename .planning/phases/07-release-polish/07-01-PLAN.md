---
phase: 07-release-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - install.sh
  - kalico-flash/flash.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can run ./install.sh and have working kflash command"
    - "User can run ./install.sh --uninstall to remove kflash"
    - "User sees warning if ~/.local/bin not in PATH"
    - "Running install.sh multiple times produces same result"
  artifacts:
    - path: "install.sh"
      provides: "Installation script with symlink and PATH handling"
      min_lines: 50
    - path: "kalico-flash/flash.py"
      provides: "Updated argparse prog name"
      contains: 'prog="kflash"'
  key_links:
    - from: "install.sh"
      to: "kalico-flash/flash.py"
      via: "symlink from ~/.local/bin/kflash"
      pattern: "ln -sfn.*flash.py"
---

<objective>
Create the install.sh script that gives users a working `kflash` command without sudo.

Purpose: Enable one-command installation that follows Klipper ecosystem conventions
Output: install.sh script at repo root, plus argparse prog name fix in flash.py
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-release-polish/07-CONTEXT.md
@.planning/phases/07-release-polish/07-RESEARCH.md
@kalico-flash/flash.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create install.sh with symlink and PATH handling</name>
  <files>install.sh</files>
  <action>
Create `install.sh` at repo root with the following behavior:

**Header and safety:**
```bash
#!/usr/bin/env bash
set -euo pipefail
```

**Configuration variables:**
- `SCRIPT_DIR` - Directory containing install.sh (use `$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)`)
- `BIN_DIR="${HOME}/.local/bin"` - XDG-compliant user bin directory
- `COMMAND_NAME="kflash"` - The command name to create
- `TARGET="${SCRIPT_DIR}/kalico-flash/flash.py"` - Full path to flash.py

**Uninstall handling (first, before anything else):**
- Check if `$1` is `--uninstall`
- If yes: remove symlink with `rm -f "${BIN_DIR}/${COMMAND_NAME}"`, print "Removed kflash", exit 0
- Don't try to remove PATH additions (per RESEARCH.md - may affect other tools)

**Prerequisite checks (warn only, don't fail):**
- Python 3.9+ check: Run `python3 -c "import sys; exit(0 if sys.version_info >= (3, 9) else 1)"` - warn if fails
- Kalico directory check: Check if `~/klipper` exists - warn if missing
- Serial access check: Check if user is in `dialout` group with `groups | grep -q dialout` - warn if not

**Installation:**
- `mkdir -p "${BIN_DIR}"` - Create bin directory (idempotent)
- `ln -sfn "${TARGET}" "${BIN_DIR}/${COMMAND_NAME}"` - Create symlink (idempotent with -sfn)
- Make flash.py executable: `chmod +x "${TARGET}"`

**PATH check and offer:**
- Check if `~/.local/bin` is in PATH using: `[[ ":${PATH}:" == *":${BIN_DIR}:"* ]]`
- If NOT in PATH:
  - Print warning: "Warning: ~/.local/bin is not in your PATH"
  - Ask user: "Add to ~/.bashrc? [y/N] "
  - If user says y/Y: append `export PATH="$HOME/.local/bin:$PATH"` to ~/.bashrc (only if not already there - use grep check)
  - Print reminder: "Run 'source ~/.bashrc' or open a new terminal"

**Success message:**
- Print "Installed kflash -> {TARGET}"
- Print "Run 'kflash --help' to get started"

**Style notes:**
- Use colored output if terminal supports it (check `[[ -t 1 ]]` and `tput colors`)
- Green for success, yellow for warnings
- Keep messages concise, not chatty
  </action>
  <verify>
Run on target Raspberry Pi:
```bash
ssh yanceya@192.168.50.50 "cd ~/kalico-flash && ./install.sh"
ssh yanceya@192.168.50.50 "which kflash"
ssh yanceya@192.168.50.50 "kflash --help"
```
All three commands should succeed.
  </verify>
  <done>
- install.sh exists at repo root
- Running `./install.sh` creates ~/.local/bin/kflash symlink
- Running `./install.sh --uninstall` removes the symlink
- Running `./install.sh` twice produces same result (idempotent)
- PATH warning appears if ~/.local/bin not in PATH
  </done>
</task>

<task type="auto">
  <name>Task 2: Update argparse prog name to kflash</name>
  <files>kalico-flash/flash.py</files>
  <action>
In flash.py, update the argparse ArgumentParser constructor:

Change:
```python
parser = argparse.ArgumentParser(
    prog="flash.py",
```

To:
```python
parser = argparse.ArgumentParser(
    prog="kflash",
```

This ensures `--help` output shows `kflash` as the command name, matching the installed symlink.
  </action>
  <verify>
```bash
cd kalico-flash && python3 flash.py --help | head -5
```
Should show `usage: kflash [...]` not `usage: flash.py [...]`
  </verify>
  <done>
- flash.py has `prog="kflash"` in argparse
- `--help` output shows correct command name
  </done>
</task>

</tasks>

<verification>
1. `./install.sh` runs without errors and creates symlink
2. `kflash --help` shows `usage: kflash [...]`
3. `./install.sh --uninstall` removes symlink cleanly
4. Running install.sh twice produces identical state (no errors, no duplicates)
5. If PATH missing, user is warned and offered to fix
</verification>

<success_criteria>
- INST-01: install.sh creates working kflash symlink
- INST-02: Install uses ~/.local/bin (no sudo)
- INST-03: Clear feedback on success
- INST-04: Warns if bin directory not in PATH
- INST-05: --uninstall removes symlink
- INST-06: Idempotent (safe to run multiple times)
</success_criteria>

<output>
After completion, create `.planning/phases/07-release-polish/07-01-SUMMARY.md`
</output>
