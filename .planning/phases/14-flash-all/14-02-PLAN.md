---
phase: 14-flash-all
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - kflash/tui.py
autonomous: true

must_haves:
  truths:
    - "Pressing 'B' in the TUI main menu triggers Flash All and returns to menu after completion"
    - "Flash All shows countdown timer after completion (same as Flash Device)"
    - "Status message updates after Flash All completes (success or failure)"
  artifacts:
    - path: "kflash/tui.py"
      provides: "Flash All wired into TUI dispatch"
      contains: "cmd_flash_all"
  key_links:
    - from: "kflash/tui.py"
      to: "kflash/flash.py"
      via: "cmd_flash_all() call"
      pattern: "cmd_flash_all"
---

<objective>
Wire cmd_flash_all() into the TUI action dispatch loop, replacing the "not yet implemented" placeholder.

Purpose: Users can trigger Flash All from the interactive menu.
Output: TUI 'B' key dispatches to cmd_flash_all() with proper status feedback and countdown timer.
</objective>

<context>
@kflash/tui.py (lines 480-483 — the placeholder for key == "b")
@kflash/flash.py (cmd_flash_all — created by Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Flash All into TUI dispatch</name>
  <files>kflash/tui.py</files>
  <action>
In `tui.py`, find the `elif key == "b":` block (around line 480) that currently sets `status_message = "Flash All: not yet implemented"`.

Replace it with:

```python
elif key == "b":
    print(key)
    from .flash import cmd_flash_all
    result = cmd_flash_all(registry, out)
    if result == 0:
        status_message = "Flash All: completed successfully"
        status_level = "success"
    else:
        status_message = "Flash All: completed with errors"
        status_level = "error"
    _countdown_return(registry.load().global_config.return_delay)
```

This follows the same pattern as the Flash Device action (key == "f") which also calls a cmd_* function, checks the return code, and runs the countdown timer.

Also update the unknown-key help message on the line that says `"Unknown key '{key}'. Use F/A/R/D/C/B/Q."` — no change needed, B is already listed.
  </action>
  <verify>Read kflash/tui.py and confirm the "b" key handler calls cmd_flash_all(), sets status_message based on return code, and calls _countdown_return().</verify>
  <done>Pressing 'B' in TUI dispatches to cmd_flash_all(), reports success/error status, and shows countdown timer before returning to menu.</done>
</task>

</tasks>

<verification>
1. The "b" key handler in tui.py calls `cmd_flash_all(registry, out)`
2. Status message reflects success (return 0) or error (non-zero return)
3. Countdown timer runs after Flash All completes
4. No "not yet implemented" text remains
</verification>

<success_criteria>
Flash All is accessible from TUI menu via 'B' key, dispatches to cmd_flash_all(), and returns to menu with appropriate status after countdown.
</success_criteria>

<output>
After completion, create `.planning/phases/14-flash-all/14-02-SUMMARY.md`
</output>
