---
phase: 11-panel-renderer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [kflash/panels.py]
autonomous: true

must_haves:
  truths:
    - "render_panel() returns multi-line string with rounded Unicode borders (╭╮╰╯) and content lines aligned correctly even when content contains ANSI color codes"
    - "Panel headers display spaced uppercase letters in square brackets (e.g. [ D E V I C E S ]) left-aligned in the top border line"
    - "render_two_column() splits items into two balanced columns with adaptive widths and whitespace gap"
    - "render_step_divider() renders a partial-width dashed line (┄) with centered label in mid-grey color"
    - "center_panel() horizontally centers a rendered panel in the terminal"
  artifacts:
    - path: "kflash/panels.py"
      provides: "Panel rendering functions"
      exports: ["render_panel", "render_two_column", "render_step_divider", "center_panel", "BOX_ROUNDED"]
      min_lines: 100
  key_links:
    - from: "kflash/panels.py"
      to: "kflash/ansi.py"
      via: "import display_width, pad_to_width, strip_ansi, get_terminal_width"
      pattern: "from kflash\\.ansi import"
    - from: "kflash/panels.py"
      to: "kflash/theme.py"
      via: "import get_theme for colors"
      pattern: "from kflash\\.theme import"
---

<objective>
Create the panel rendering module with pure functions that produce bordered panels, two-column layouts, spaced-letter headers, and step dividers — all returning multi-line strings ready for print().

Purpose: Phase 12-14 TUI screens need reusable panel rendering primitives. This module provides them without any screen management or input handling.
Output: `kflash/panels.py` with render_panel(), render_two_column(), render_step_divider(), center_panel()
</objective>

<context>
@.planning/phases/11-panel-renderer/11-RESEARCH.md
@.planning/phases/11-panel-renderer/11-CONTEXT.md
@kflash/ansi.py
@kflash/theme.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create panels.py with all rendering functions</name>
  <files>kflash/panels.py</files>
  <action>
Create `kflash/panels.py` with these components:

**Module constants:**
- `BOX_ROUNDED` dict with keys: `tl` (╭), `tr` (╮), `bl` (╰), `br` (╯), `h` (─), `v` (│)
- `MAX_PANEL_WIDTH = 80` — default max panel width

**Function: `render_panel(header, content_lines, max_width=80, padding=2) -> str`**
- Spaced header: `"devices"` -> `"[ D E V I C E S ]"` — always uppercase
- Calculate `header_plain_width` from plain text BEFORE applying theme colors
- Apply `theme.header` color to header display string, `theme.border` to border chars
- Inner width = min(max content width + 2*padding, max_width - 2)
- Top border: `╭[ H E A D E R ]────────────╮` (header left-aligned, remaining filled with ─)
- Content lines: `│  content padded to inner_width  │` using pad_to_width() for ANSI-aware alignment
- Bottom border: `╰──────────────────────────╯`
- Return "\n".join(lines)
- Handle empty content_lines gracefully (render panel with just borders)

**Function: `render_two_column(items, gap=4) -> list[str]`**
- `items` is list of `(number, label)` tuples like `("#1", "Flash Device")`
- Split: `mid = (len(items) + 1) // 2` (left column gets extra item if odd)
- Format each item: `{theme.label}#1{reset} {theme.subtle}▸{reset} {label}`
- Calculate left column width via display_width() (ANSI-aware)
- Pad left column items to left_width, add gap spaces, then right column item
- Return list of formatted lines (no borders — caller wraps in panel)
- Handle empty items (return []) and single item (one column)

**Function: `render_step_divider(label, total_width=60) -> str`**
- Label text: ` {label} ` (spaces around label)
- Dash char: `┄` (light dashed)
- Calculate dashes: `(total_width - label_width) // 2` each side
- Apply `theme.subtle` to dashes and `theme.dim` to label
- Return single formatted line

**Function: `center_panel(panel_str, terminal_width=None) -> str`**
- If terminal_width is None, call get_terminal_width()
- Split panel_str into lines
- Find max display_width across all lines
- If max_width >= terminal_width, return as-is
- Otherwise prepend `(terminal_width - max_width) // 2` spaces to each line
- Return "\n".join()

Use `from __future__ import annotations` at top. Import from kflash.ansi and kflash.theme. Add docstrings to all public functions.
  </action>
  <verify>
Run: `python -c "from kflash.panels import render_panel, render_two_column, render_step_divider, center_panel, BOX_ROUNDED; print('imports ok')"` — must print "imports ok".
Run: `python -c "from kflash.panels import render_panel; print(render_panel('test', ['hello', 'world']))"` — must show rounded borders with spaced header.
Run: `python -c "from kflash.panels import render_two_column; print('\n'.join(render_two_column([('#1','A'),('#2','B'),('#3','C')])))"` — must show two columns.
Run: `python -c "from kflash.panels import render_step_divider; print(render_step_divider('step 1'))"` — must show dashed divider.
  </verify>
  <done>All four public functions importable and produce correctly formatted output with rounded Unicode borders, spaced headers, balanced columns, and dashed dividers.</done>
</task>

<task type="auto">
  <name>Task 2: Integration smoke test with colored content</name>
  <files>kflash/panels.py</files>
  <action>
Write and run a quick smoke test script (not committed — just for verification) that exercises panels with ANSI-colored content to confirm alignment is correct:

```python
from kflash.theme import get_theme
from kflash.panels import render_panel, render_two_column, render_step_divider, center_panel

theme = get_theme()

# Test 1: Panel with colored content
colored_lines = [
    f"{theme.text}Octopus Pro{theme.reset}  {theme.subtle}stm32h723{theme.reset}",
    f"{theme.text}Nitehawk 36{theme.reset}  {theme.subtle}rp2040{theme.reset}",
]
panel = render_panel("devices", colored_lines)
print(panel)
print()

# Test 2: Two-column in a panel
actions = [("#1", "Flash Device"), ("#2", "Flash All"), ("#3", "Add Device"), ("#4", "Remove Device"), ("#5", "Settings")]
col_lines = render_two_column(actions)
panel2 = render_panel("actions", col_lines)
print(panel2)
print()

# Test 3: Step divider
print(render_step_divider("step 1"))
print(render_step_divider("1/2 Octopus Pro"))
print()

# Test 4: Centered panel
print(center_panel(panel))
```

Verify:
- All right borders (│ and ╯) align vertically — no jagged right edge
- Header text is visible and colored within top border
- Two-column items are evenly spaced
- Step divider label is centered between dashes

Fix any alignment issues found. The most likely issue is pad_to_width miscalculation when content has ANSI codes — ensure display_width is used consistently.
  </action>
  <verify>Visual inspection of smoke test output confirms: (1) right borders align vertically, (2) header spaced letters visible in top border, (3) two columns balanced, (4) step divider centered.</verify>
  <done>Panel rendering produces visually correct output with colored content — borders aligned, headers formatted, columns balanced, dividers centered.</done>
</task>

</tasks>

<verification>
1. `from kflash.panels import render_panel, render_two_column, render_step_divider, center_panel, BOX_ROUNDED` succeeds
2. `render_panel("devices", [...colored lines...])` produces panel with aligned right borders
3. `render_two_column(items)` returns balanced columns
4. `render_step_divider("step 1")` returns dashed line with centered label
5. `center_panel(panel_str)` adds left padding for centering
</verification>

<success_criteria>
- kflash/panels.py exists with 4 public functions + BOX_ROUNDED constant
- All functions use Phase 10's ANSI utilities (display_width, pad_to_width) for width calculation
- Colored content does not break border alignment
- Two-column layout balances items correctly (left column gets extra if odd count)
- Module has no external dependencies beyond stdlib + kflash.ansi + kflash.theme
</success_criteria>

<output>
After completion, create `.planning/phases/11-panel-renderer/11-01-SUMMARY.md`
</output>
